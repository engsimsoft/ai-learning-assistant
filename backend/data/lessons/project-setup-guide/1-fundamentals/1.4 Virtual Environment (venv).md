# 1.4 Virtual Environment (venv) - Изоляция зависимостей

#### 🎯 Зачем нужно виртуальное окружение

**Проблема глобальной установки пакетов:**
- Проект A требует Django 3.0, Проект B требует Django 4.0 → конфликт!
- Обновил пакет для нового проекта → старый проект сломался
- Системные пакеты Python смешались с проектными → хаос
- "На моём компьютере работает, на твоём нет" → разные версии
- Переустановил систему → потерял все пакеты всех проектов
- Не можешь откатить изменения зависимостей одного проекта

**Virtual environment решает:**
- ✅ Каждый проект в своей изолированной "песочнице"
- ✅ Разные версии одного пакета в разных проектах - без конфликтов
- ✅ Системный Python не тронут (безопасность)
- ✅ Воспроизводимое окружение (requirements.txt)
- ✅ Легко удалить всё для проекта (просто удали папку venv/)
- ✅ Легко начать с чистого листа

---

#### 🏪 Аналогия: Песочницы для детей

**Без виртуального окружения** = все дети играют в одной песочнице:
- Один ребёнок хочет строить замок (проект A)
- Другой хочет копать тоннель (проект B)
- Они мешают друг другу, ломают постройки
- Невозможно сохранить прогресс каждого

**С виртуальным окружением** = у каждого ребёнка своя песочница:
- Каждый строит что хочет
- Никто никому не мешает
- Можно иметь разные наборы игрушек (пакетов)
- Сломал что-то в одной песочнице → другие не пострадали
- Можно выровнять одну песочницу, не трогая другие

---

#### 📐 Визуализация: Глобальная установка vs Virtual Environment

> **Что такое ASCII схема?** Это рисунок из текстовых символов - стрелок, линий, рамок. Мы используем их чтобы показать процессы и связи наглядно, прямо в тексте. Это как блок-схема, но нарисованная символами ┌─┐│└┘↓.

```
═══════════════════════════════════════════════════════════
           ❌ БЕЗ ВИРТУАЛЬНОГО ОКРУЖЕНИЯ
═══════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────┐
│               СИСТЕМНЫЙ PYTHON /usr/bin/python          │
│                                                          │
│  Глобальные пакеты (один набор для ВСЕХ проектов):     │
│  ├── Django==3.0                                        │
│  ├── requests==2.25.0                                   │
│  ├── numpy==1.20.0                                      │
│  └── pandas==1.2.0                                      │
└────────────┬────────────────────────┬───────────────────┘
             │                        │
             ↓                        ↓
  ┌──────────────────┐    ┌──────────────────┐
  │   Проект A       │    │   Проект B       │
  │                  │    │                  │
  │ Нужен Django 3.0 │    │ Нужен Django 4.0 │
  │      ✅           │    │      ❌          │
  └──────────────────┘    └──────────────────┘
                                    │
                                    ↓
                          КОНФЛИКТ! Нельзя иметь
                          две версии Django одновременно


═══════════════════════════════════════════════════════════
           ✅ С ВИРТУАЛЬНЫМ ОКРУЖЕНИЕМ (venv)
═══════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────┐
│           СИСТЕМНЫЙ PYTHON /usr/bin/python              │
│           (остаётся чистым, не тронут)                  │
└─────────────────────────────────────────────────────────┘
                           │
                           │ создаёт копии →
        ┌──────────────────┴──────────────────┐
        ↓                                      ↓
┌──────────────────┐                  ┌──────────────────┐
│   Проект A       │                  │   Проект B       │
│                  │                  │                  │
│ venv/            │                  │ venv/            │
│ ├── bin/python   │                  │ ├── bin/python   │
│ └── lib/         │                  │ └── lib/         │
│   ├── Django 3.0 │                  │   ├── Django 4.0 │
│   ├── requests   │                  │   ├── FastAPI    │
│   └── numpy      │                  │   └── pandas     │
│                  │                  │                  │
│ ✅ Своя копия    │                  │ ✅ Своя копия    │
│    Python        │                  │    Python        │
│ ✅ Свои пакеты   │                  │ ✅ Свои пакеты   │
│ ✅ Изолировано   │                  │ ✅ Изолировано   │
└──────────────────┘                  └──────────────────┘

        Проекты не конфликтуют!
        Каждый имеет нужные ему версии.


             КАК ЭТО РАБОТАЕТ:
             
   Без активации venv          С активацией venv
   ═════════════════           ═════════════════
   
   python script.py       →    python script.py
         ↓                            ↓
   /usr/bin/python             project/venv/bin/python
   использует глобальные       использует локальные
   пакеты                      пакеты проекта
```

---

#### 💡 Как работает Virtual Environment

**Что такое venv технически:**
- venv - это **копия Python интерпретатора** в папке проекта
- Папка `venv/` содержит:
  - `venv/bin/python` - локальная копия Python
  - `venv/lib/` - локальные пакеты (только для этого проекта)
  - `venv/include/` - заголовочные файлы
- Когда активируешь venv → команда `python` указывает на локальную копию
- Пакеты устанавливаются в `venv/lib/`, а не глобально

**Когда активируешь venv:**
```bash
source venv/bin/activate  # macOS/Linux
venv\Scripts\activate     # Windows
```

**Что происходит:**
1. Переменная окружения `PATH` изменяется
2. Теперь `python` → `venv/bin/python` (локальная копия)
3. `pip install` устанавливает пакеты в `venv/lib/`
4. Системный Python не тронут

**Визуально в терминале:**
```bash
# До активации
user@computer:~/project$ python --version
Python 3.11.0  # системный

# После активации
(venv) user@computer:~/project$ python --version
Python 3.11.0  # локальная копия из venv/

# (venv) в начале строки = venv активен
```

---

#### 💡 Как создать и использовать venv

**Создание виртуального окружения:**

```bash
# 1. Зайди в папку проекта
cd my-project

# 2. Создай виртуальное окружение
python -m venv venv
# или
python3 -m venv venv

# ЗАЧЕМ: Создаёт папку venv/ с копией Python
```

**Что создалось:**
```
my-project/
├── venv/                 # ← папка виртуального окружения
│   ├── bin/              # Исполняемые файлы (python, pip)
│   │   ├── python        # Локальная копия Python
│   │   ├── pip           # Локальный pip
│   │   └── activate      # Скрипт активации
│   ├── lib/              # Установленные пакеты
│   │   └── python3.11/
│   │       └── site-packages/  # Пакеты здесь
│   └── include/          # Заголовочные файлы
└── ... (остальные файлы проекта)
```

**Активация виртуального окружения:**

```bash
# macOS / Linux
source venv/bin/activate

# Windows (cmd)
venv\Scripts\activate.bat

# Windows (PowerShell)
venv\Scripts\Activate.ps1

# ЗАЧЕМ: Переключает python/pip на локальную копию
```

**Проверка активации:**
```bash
# После активации увидишь (venv) в начале строки:
(venv) user@computer:~/project$

# Проверка какой Python используется:
which python
# Output: /Users/user/project/venv/bin/python

# Проверка где pip установит пакеты:
pip show pip
# Output: Location: /Users/user/project/venv/lib/python3.11/site-packages
```

**Установка пакетов (venv активен):**
```bash
(venv) $ pip install fastapi uvicorn
# Пакеты устанавливаются в venv/lib/
# Системный Python не тронут!

(venv) $ pip freeze > requirements.txt
# Сохраняем список пакетов
```

**Деактивация виртуального окружения:**
```bash
(venv) $ deactivate
# Возвращаешься к системному Python
user@computer:~/project$  # (venv) исчез
```

---

#### ✅ Best Practices

**1. ВСЕГДА создавай venv для каждого Python проекта**

```bash
✅ Правильный workflow:
   1. mkdir new-project
   2. cd new-project
   3. python -m venv venv  ← СРАЗУ!
   4. source venv/bin/activate
   5. pip install пакеты
   
❌ Неправильный workflow:
   1. mkdir new-project
   2. cd new-project
   3. pip install пакеты  ← В глобальное окружение!
```

**ЗАЧЕМ:**
- Изоляция с первого пакета
- Нет конфликтов между проектами
- Легко воспроизвести окружение

**2. Папка venv/ ВСЕГДА называется "venv"**

```bash
✅ Стандартное имя:
   python -m venv venv
   
❌ Нестандартные имена:
   python -m venv myenv
   python -m venv .venv
   python -m venv env
```

**ЗАЧЕМ:**
- Универсальность (все знают где искать)
- ИИ ожидает папку `venv/`
- .gitignore шаблоны используют `venv/`
- Меньше путаницы

**Исключение:** Некоторые используют `.venv` (с точкой) чтобы скрыть папку. Это тоже ок, но venv без точки - стандарт.

**3. venv/ в .gitignore ВСЕГДА**

```bash
✅ .gitignore должен содержать:
   venv/
   venv
   *.pyc
   __pycache__/
   
❌ НЕ коммитить venv/ в Git:
   - Это тысячи файлов, сотни мегабайт
   - У каждого разработчика своё venv
   - requirements.txt - это всё что нужно
```

**ЗАЧЕМ:**
- Репозиторий лёгкий
- Каждый создаёт своё venv локально
- Воспроизводимость через requirements.txt

**4. Активируй venv перед каждой работой**

```bash
✅ Открыл терминал → сразу активируй:
   cd my-project
   source venv/bin/activate
   # Теперь работай
   
❌ Забыл активировать:
   pip install pandas  ← установится глобально!
```

**Как проверить что venv активен:**
- Видишь `(venv)` в начале строки терминала
- `which python` → показывает путь к venv/bin/python

**5. Один проект = одно venv**

```bash
✅ Структура:
   project-a/
   ├── venv/           # venv для project-a
   └── ...
   
   project-b/
   ├── venv/           # отдельное venv для project-b
   └── ...
   
❌ Общее venv для нескольких проектов:
   shared-venv/        # ❌ НЕ ДЕЛАЙ ТАК!
   project-a/
   project-b/
```

**ЗАЧЕМ:**
- Изоляция между проектами
- Можно удалить проект со всеми зависимостями
- Конфликты невозможны

**6. Пересоздай venv если что-то сломалось**

```bash
# Если venv сломан или странные ошибки:

1. Деактивируй venv
   deactivate

2. Удали старый venv
   rm -rf venv/

3. Создай новый venv
   python -m venv venv

4. Активируй
   source venv/bin/activate

5. Установи пакеты заново
   pip install -r requirements.txt

✅ Чистое окружение за 1 минуту!
```

**ЗАЧЕМ:**
- venv - это просто папка, можно пересоздать
- Быстрее чем искать проблему
- Гарантирует чистое состояние

---

#### 🤖 Диалог с Claude Code

**❌ Плохой диалог:**

```
Ты: Создай FastAPI проект

Claude Code: [создаёт код]

Ты: [запускаешь без venv]
pip install fastapi  ← устанавливается глобально ❌
```

**Почему плохо:**
- Не создал venv сразу
- Пакеты в глобальном окружении
- Конфликты с другими проектами
- Нельзя воспроизвести окружение

---

**✅ Хороший диалог:**

```
Ты: Создай FastAPI проект "EngineCamPro v2".

ВАЖНО - первые шаги:
1. Создай README.md с инструкцией создания venv:
   
   ## Установка
   
   1. Создай виртуальное окружение:
      ```bash
      python -m venv venv
      ```
      
   2. Активируй виртуальное окружение:
      - macOS/Linux: `source venv/bin/activate`
      - Windows: `venv\Scripts\activate`
      
   3. Установи зависимости:
      ```bash
      pip install -r requirements.txt
      ```
   
   ЗАЧЕМ: venv изолирует зависимости этого проекта
   
2. Создай .gitignore с:
   venv/
   __pycache__/
   *.pyc
   .env
   
   ЗАЧЕМ: venv/ не должен попасть в Git (тысячи файлов)
   
3. Создай requirements.txt с:
   fastapi==0.104.1
   uvicorn[standard]==0.24.0
   
   ЗАЧЕМ: Другие создадут идентичное venv из этого файла
   
4. В README.md объясни про venv:
   - Что такое виртуальное окружение
   - Зачем оно нужно (изоляция от других проектов)
   - Как проверить что venv активен (видишь (venv) в терминале)

Claude Code:
[создаёт структуру проекта]
[создаёт README.md с детальной инструкцией про venv]
[создаёт .gitignore с venv/]
[создаёт requirements.txt]
[НЕ создаёт venv - это делаешь ТЫ вручную командой]

Результат: ✅ Проект готов
Следующий шаг: ТЫ создаёшь venv командой: python -m venv venv
```

**Почему хорошо:**
- ✅ ИИ создаёт инструкции для venv в README.md
- ✅ ИИ объясняет зачем нужен venv
- ✅ venv/ добавлен в .gitignore
- ✅ requirements.txt готов для установки в venv
- ✅ Пользователь создаёт venv вручную (правильный workflow)
- ✅ Чёткое объяснение каждого шага

---

#### ✅ Чек-лист Virtual Environment

**Создание и активация:**
- [ ] venv создан командой: `python -m venv venv`
- [ ] Папка venv/ появилась в проекте
- [ ] venv активирован: `source venv/bin/activate` (macOS/Linux) или `venv\Scripts\activate` (Windows)
- [ ] В терминале видишь `(venv)` в начале строки
- [ ] `which python` показывает путь к venv/bin/python

**Изоляция работает:**
- [ ] `pip list` показывает минимальный набор пакетов (только встроенные)
- [ ] Пакеты устанавливаются в venv/lib/, не глобально
- [ ] Системный Python не затронут (проверь деактивировав venv)

**Git и документация:**
- [ ] venv/ добавлен в .gitignore
- [ ] venv/ НЕ закоммичен в Git (проверь: git status)
- [ ] README.md содержит инструкцию создания venv
- [ ] README.md объясняет зачем нужен venv
- [ ] requirements.txt создан для воспроизводимости

**Workflow:**
- [ ] При открытии проекта активируешь venv СРАЗУ
- [ ] Все пакеты устанавливаешь ТОЛЬКО в активном venv
- [ ] После установки пакета обновляешь requirements.txt
- [ ] Перед коммитом проверяешь что venv/ в .gitignore

**Коллега клонирует проект:**
- [ ] Он создаёт своё venv: `python -m venv venv`
- [ ] Активирует: `source venv/bin/activate`
- [ ] Устанавливает: `pip install -r requirements.txt`
- [ ] Получает идентичное окружение ✅

---

#### 🎯 Связь с EngineCamPro

**EngineCamPro v1 (Streamlit) - возможно БЕЗ venv:**
```bash
# Если не использовал venv:
pip install streamlit numpy pandas plotly  # ❌ глобально

# Проблемы:
- Конфликт с другими проектами
- Переустановил систему → потерял всё
- "У меня работало" (разные версии на разных компьютерах)
```

**EngineCamPro v2 (FastAPI + React) - С venv:**

Backend:
```bash
# Правильный workflow:
cd enginecampro-v2/backend
python -m venv venv
source venv/bin/activate
pip install -r requirements.txt

# requirements.txt:
fastapi==0.104.1
uvicorn[standard]==0.24.0
sqlalchemy==2.0.23
numpy==1.24.0
scipy==1.11.0

# ✅ Изолировано от других проектов
# ✅ Можно воспроизвести на любом компьютере
# ✅ Легко обновить пакеты без риска сломать другое
```

Frontend (Node.js):
```bash
# Node.js автоматически изолирован через node_modules/
# Каждый проект имеет свои пакеты в node_modules/
# Аналог venv, но встроенный в экосистему Node.js
```

**Почему это важно для v2:**
- Backend и Frontend - отдельные проекты
- У Backend своё venv с Python пакетами
- У Frontend свой node_modules/ с JS пакетами
- Полная изоляция между проектами
- Можно разрабатывать параллельно без конфликтов

---

**Следующий раздел:** 1.5 Environment Variables (.env)