# 1.3 Dependencies (управление зависимостями)

#### 🎯 Зачем нужно правильное управление зависимостями

**Проблема хаотичных зависимостей:**
- Устанавливаешь пакеты глобально → конфликты между проектами
- Коллега клонирует проект → не знает какие библиотеки ставить
- Обновил пакет → всё сломалось (несовместимые версии)
- Через полгода не помнишь какие версии использовал
- Deploy на сервер → "у меня работало, а тут не работает"

**Правильное управление даёт:**
- ✅ Изолированные зависимости для каждого проекта
- ✅ Точные версии зафиксированы (воспроизводимость)
- ✅ Другой разработчик установит идентичное окружение
- ✅ Deploy предсказуем (те же версии что и локально)
- ✅ Безопасность (контроль над уязвимостями)

---

#### 🏪 Аналогия: Рецепт блюда

**Хаотичные зависимости** = готовить без рецепта:
- "Добавь сахар" → сколько? 100г или 1кг?
- Друг хочет повторить → не знает ингредиенты
- Через год пытаешься вспомнить → не получается

**Правильные зависимости** = детальный рецепт:
- Список ингредиентов с точными количествами
- Версии продуктов (молоко 3.2%, а не любое)
- Любой может повторить точно так же
- Результат предсказуем

---

#### 📐 Визуализация: Как работают зависимости

> **Что такое ASCII схема?** Это рисунок из текстовых символов - стрелок, линий, рамок. Мы используем их чтобы показать процессы и связи наглядно, прямо в тексте. Это как блок-схема, но нарисованная символами ┌─┐│└┘↓.

```
┌─────────────────────────────────────────────────────────┐
│                   ТЫ УСТАНАВЛИВАЕШЬ ПАКЕТ               │
│                                                          │
│  pip install fastapi                                    │
│  или                                                     │
│  npm install react                                      │
│                                                          │
└────────────────────┬────────────────────────────────────┘
                     │
                     ↓
┌─────────────────────────────────────────────────────────┐
│              ПАКЕТ ИМЕЕТ СВОИ ЗАВИСИМОСТИ               │
│                                                          │
│  fastapi зависит от:                                    │
│  ├── starlette                                          │
│  ├── pydantic                                           │
│  └── typing-extensions                                  │
│                                                          │
│  ЗАЧЕМ: Библиотеки используют другие библиотеки         │
└────────────────────┬────────────────────────────────────┘
                     │
                     ↓
┌─────────────────────────────────────────────────────────┐
│           МЕНЕДЖЕР ПАКЕТОВ УСТАНАВЛИВАЕТ ВСЁ            │
│                                                          │
│  pip или npm:                                           │
│  1. Скачивает fastapi                                   │
│  2. Читает список зависимостей fastapi                  │
│  3. Скачивает starlette, pydantic, и т.д.               │
│  4. Устанавливает всё в правильном порядке              │
│                                                          │
│  ЗАЧЕМ: Автоматизация установки всего дерева            │
└────────────────────┬────────────────────────────────────┘
                     │
                     ↓
┌─────────────────────────────────────────────────────────┐
│              ФИКСАЦИЯ В ФАЙЛЕ ЗАВИСИМОСТЕЙ              │
│                                                          │
│  Python: requirements.txt                               │
│  fastapi==0.104.1                                       │
│  starlette==0.27.0                                      │
│  pydantic==2.5.0                                        │
│                                                          │
│  Node.js: package.json                                  │
│  {                                                      │
│    "dependencies": {                                    │
│      "react": "^18.2.0"                                 │
│    }                                                    │
│  }                                                      │
│                                                          │
│  ЗАЧЕМ: Другие смогут установить те же версии           │
└────────────────────┬────────────────────────────────────┘
                     │
                     ↓
┌─────────────────────────────────────────────────────────┐
│               КОЛЛЕГА КЛОНИРУЕТ ПРОЕКТ                  │
│                                                          │
│  git clone project                                      │
│  pip install -r requirements.txt                        │
│  или                                                     │
│  npm install                                            │
│                                                          │
│  Результат: Идентичное окружение! ✅                     │
└─────────────────────────────────────────────────────────┘


              ПРОБЛЕМА БЕЗ ФИКСАЦИИ ВЕРСИЙ:
              
   Твой компьютер          Коллега          Production
   (октябрь 2024)        (февраль 2025)     (март 2025)
   
   fastapi 0.104.1    →  fastapi 0.110.0  → fastapi 0.115.0
   
   У тебя работает    →  У него НЕ работает → На сервере ошибки
   
   ЗАЧЕМ ФИКСИРОВАТЬ: Все используют одинаковые версии
```

---

#### 💡 Как это работает: Python (requirements.txt)

**Создание requirements.txt:**

```bash
# 1. Активируй venv (важно!)
source venv/bin/activate

# 2. Установи пакеты
pip install fastapi uvicorn sqlalchemy pydantic

# 3. Зафиксируй все зависимости (включая транзитивные)
pip freeze > requirements.txt

# Результат в requirements.txt:
# fastapi==0.104.1
# uvicorn==0.24.0
# sqlalchemy==2.0.23
# pydantic==2.5.0
# starlette==0.27.0        ← транзитивная (зависимость fastapi)
# typing-extensions==4.8.0  ← транзитивная
# ...и другие
```

**ЗАЧЕМ pip freeze:**
- Фиксирует **все** пакеты с **точными** версиями
- Включает транзитивные зависимости (зависимости зависимостей)
- Гарантирует воспроизводимость

**Установка из requirements.txt:**

```bash
# На другом компьютере или сервере:

# 1. Клонируй проект
git clone https://github.com/user/project.git
cd project

# 2. Создай venv
python -m venv venv
source venv/bin/activate

# 3. Установи все зависимости
pip install -r requirements.txt

# Результат: Точно те же версии что у тебя!
```

**Обновление зависимостей:**

```bash
# Установил новый пакет
pip install pandas

# ОБЯЗАТЕЛЬНО обнови requirements.txt!
pip freeze > requirements.txt

# Закоммить изменения
git add requirements.txt
git commit -m "Add pandas dependency"
```

---

#### 💡 Как это работает: Node.js (package.json)

**Создание package.json автоматически:**

```bash
# Vite или Next.js создают package.json автоматически
npm create vite@latest my-app
# или
npx create-next-app@latest my-app

# package.json уже создан с зависимостями!
```

**Структура package.json:**

```json
{
  "name": "enginecampro-frontend",
  "version": "1.0.0",
  "dependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0"
  },
  "devDependencies": {
    "vite": "^5.0.0",
    "typescript": "^5.2.0"
  }
}
```

**Семантическое версионирование (semver):**

```
"react": "^18.2.0"
         │ │  │  │
         │ │  │  └─ Patch (багфиксы)      18.2.0 → 18.2.1 ✅
         │ │  └──── Minor (новые фичи)    18.2.0 → 18.3.0 ✅
         │ └─────── Major (breaking)      18.2.0 → 19.0.0 ❌
         └───────── Карет (^) разрешает Minor и Patch

"react": "~18.2.0"  ← Тильда (~) разрешает только Patch
"react": "18.2.0"   ← Точная версия (самое строгое)
```

**ЗАЧЕМ карет (^):**
- Автоматически получаешь багфиксы и новые фичи
- Но защищён от breaking changes
- Баланс между безопасностью и актуальностью

**Установка зависимостей:**

```bash
# Коллега клонирует проект
git clone https://github.com/user/project.git
cd project

# npm install читает package.json и устанавливает всё
npm install

# Создаётся node_modules/ с пакетами
# Создаётся package-lock.json (точные версии)
```

**package-lock.json - что это:**

```
package.json      →  "react": "^18.2.0"  (диапазон версий)
package-lock.json →  "react": "18.2.15"  (точная версия)

ЗАЧЕМ: npm install установит ту же версию что у тебя
```

**Добавление новой зависимости:**

```bash
# Установка и автоматическое добавление в package.json
npm install axios

# package.json обновлён автоматически!
{
  "dependencies": {
    "react": "^18.2.0",
    "axios": "^1.6.0"  ← добавлено
  }
}

# Закоммить изменения
git add package.json package-lock.json
git commit -m "Add axios for API calls"
```

**Dev зависимости vs Production:**

```bash
# Production зависимость (нужна в продакшене)
npm install react

# Dev зависимость (только для разработки)
npm install --save-dev typescript eslint

# package.json:
{
  "dependencies": {
    "react": "^18.2.0"     ← попадёт в production
  },
  "devDependencies": {
    "typescript": "^5.2.0"  ← только для dev
  }
}
```

---

#### ✅ Best Practices

**1. ВСЕГДА используй venv (Python) / локальную установку (Node.js)**

```bash
✅ Python:
   python -m venv venv
   source venv/bin/activate
   pip install fastapi
   
❌ Python:
   pip install fastapi  # Без venv - в глобальную систему!

✅ Node.js:
   npm install  # Всегда локально в node_modules/
```

**ЗАЧЕМ:**
- Python без venv → пакеты в системе → конфликты между проектами
- Node.js всегда локально → изоляция автоматическая

**2. Фиксируй зависимости сразу после установки**

```bash
✅ Python:
   pip install pandas
   pip freeze > requirements.txt  ← СРАЗУ!
   git add requirements.txt
   git commit -m "Add pandas"

✅ Node.js:
   npm install axios
   # package.json обновлён автоматически
   git add package.json package-lock.json
   git commit -m "Add axios"

❌ Забыл обновить requirements.txt:
   Коллега не установит pandas → ошибка
```

**3. Коммить файлы зависимостей в Git**

```bash
✅ КОММИТИТЬ:
   requirements.txt     (Python)
   package.json         (Node.js)
   package-lock.json    (Node.js)

❌ НЕ КОММИТИТЬ:
   venv/                (Python) → в .gitignore
   node_modules/        (Node.js) → в .gitignore
```

**ЗАЧЕМ:**
- requirements.txt/package.json → маленькие файлы, список зависимостей
- venv/node_modules/ → тысячи файлов, гигабайты, генерируются из списка

**4. Минимизируй количество зависимостей**

```bash
✅ Перед установкой спроси себя:
   - Действительно ли нужна эта библиотека?
   - Могу ли написать сам в 10 строк?
   - Активно ли поддерживается?

❌ Устанавливать библиотеку для одной функции
   npm install left-pad  # Библиотека из 11 строк
```

**ЗАЧЕМ:**
- Меньше зависимостей → меньше уязвимостей
- Меньше обновлений → меньше breaking changes
- Быстрее установка и сборка

**5. Регулярно проверяй уязвимости**

```bash
# Python
pip install safety
safety check

# Node.js
npm audit
npm audit fix  # Автоматическое исправление
```

**ЗАЧЕМ:**
- Библиотеки могут содержать уязвимости
- Обновления закрывают дыры безопасности
- Production приложение должно быть безопасным

**6. Обновляй зависимости осознанно**

```bash
✅ Плановое обновление:
   1. Прочитать CHANGELOG библиотеки
   2. Обновить в dev окружении
   3. Протестировать
   4. Обновить requirements.txt / package.json
   5. Задеплоить

❌ npm update или pip install --upgrade всего подряд
   без тестирования
```

**ЗАЧЕМ:**
- Breaking changes могут сломать приложение
- Нужно время на адаптацию к новому API
- Обновление = mini-миграция

---

#### 🤖 Диалог с Claude Code

**❌ Плохой диалог:**

```
Ты: Добавь обработку CSV файлов

Claude Code: [пишет код с импортом pandas]

Ты: [запускаешь] → ImportError: No module named 'pandas'
```

**Почему плохо:**
- Не попросил ИИ обновить requirements.txt
- ИИ не знал что нужно добавить зависимость
- Получил нерабочий код

---

**✅ Хороший диалог для Python:**

```
Ты: Добавь обработку CSV файлов для импорта данных о кулачках.

ТРЕБОВАНИЯ:
1. Используй pandas для чтения CSV
   ЗАЧЕМ: Мощная библиотека для табличных данных
   
2. ОБЯЗАТЕЛЬНО добавь pandas в requirements.txt
   ЗАЧЕМ: Другие разработчики смогут установить
   
3. Покажи мне как установить:
   pip install pandas
   pip freeze > requirements.txt
   
4. Добавь валидацию данных из CSV:
   - Проверка обязательных колонок
   - Проверка типов данных
   ЗАЧЕМ: CSV может содержать ошибки

Claude Code:
[создаёт код с pandas]
[обновляет requirements.txt]
[показывает команды установки]

✅ Результат: Код работает + requirements.txt обновлён
```

**Почему хорошо:**
- ✅ Указал библиотеку явно (pandas)
- ✅ Попросил обновить requirements.txt
- ✅ Попросил показать команды установки
- ✅ Объяснил ЗАЧЕМ нужна библиотека
- ✅ Добавил валидацию для надёжности

---

**✅ Хороший диалог для Node.js:**

```
Ты: Добавь HTTP клиент для запросов к Backend API.

ТРЕБОВАНИЯ:
1. Используй axios (не fetch)
   ЗАЧЕМ: Лучшая обработка ошибок, interceptors, TypeScript типы
   
2. Добавь axios в package.json:
   npm install axios
   
3. Создай API service слой:
   - Base URL из .env
   - Error handling
   - Request/response interceptors
   ЗАЧЕМ: Централизованное управление запросами
   
4. TypeScript типы для API responses
   ЗАЧЕМ: Автокомплит и проверка типов

Claude Code:
[устанавливает axios]
[package.json обновлён автоматически]
[создаёт API service с типами]

✅ Результат: API клиент готов + зависимость добавлена
```

**Почему хорошо:**
- ✅ Выбрал конкретную библиотеку (axios)
- ✅ Объяснил почему axios, а не fetch
- ✅ Попросил создать service слой (архитектура)
- ✅ TypeScript типы для безопасности

---

#### ✅ Чек-лист управления зависимостями

**Python проект:**
- [ ] Virtual environment создан и активирован
- [ ] requirements.txt существует и актуален
- [ ] После каждой установки пакета → `pip freeze > requirements.txt`
- [ ] venv/ добавлен в .gitignore
- [ ] requirements.txt закоммичен в Git
- [ ] Коллега может установить: `pip install -r requirements.txt`

**Node.js проект:**
- [ ] package.json существует
- [ ] package-lock.json существует
- [ ] node_modules/ добавлен в .gitignore
- [ ] package.json и package-lock.json закоммичены в Git
- [ ] После установки пакета → оба файла обновлены
- [ ] Коллега может установить: `npm install`

**Общие правила:**
- [ ] Минимальное количество зависимостей (только нужные)
- [ ] Зависимости из надёжных источников
- [ ] Регулярная проверка уязвимостей (safety check / npm audit)
- [ ] Документированы нестандартные зависимости в README.md
- [ ] Обновления зависимостей тестируются перед deploy

**Проверка работоспособности:**
- [ ] Свежий клон проекта + установка зависимостей → всё работает
- [ ] Проект запускается без ошибок ImportError / ModuleNotFoundError
- [ ] Все импорты в коде соответствуют requirements.txt / package.json

---

#### 🎯 Связь с EngineCamPro

**EngineCamPro v1 (Streamlit):**
```
requirements.txt:
streamlit==1.28.0
numpy==1.24.0
pandas==2.0.0
plotly==5.17.0
```

**EngineCamPro v2 (FastAPI + React):**

Backend requirements.txt:
```
fastapi==0.104.1
uvicorn[standard]==0.24.0
sqlalchemy==2.0.23
pydantic==2.5.0
numpy==1.24.0      ← Математика из v1
scipy==1.11.0      ← Математика из v1
```

Frontend package.json:
```json
{
  "dependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "axios": "^1.6.0",
    "recharts": "^2.10.0"
  },
  "devDependencies": {
    "vite": "^5.0.0",
    "typescript": "^5.2.0"
  }
}
```

**Что изменилось:**
- Backend: numpy и scipy остались (математическое ядро)
- Backend: добавлены FastAPI, SQLAlchemy (новая архитектура)
- Frontend: полностью новые зависимости (React экосистема)

**Миграция зависимостей:**
1. Математические библиотеки (numpy, scipy) → перенесены как есть
2. Streamlit → удалён (заменён на FastAPI + React)
3. Plotly → заменён на Recharts (React-friendly)

---

**Следующий раздел:** 1.4 Virtual Environment (venv)