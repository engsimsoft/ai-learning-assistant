# 3.3 Environment Variables в Next.js

#### 🎯 Зачем нужны переменные окружения

**Проблема без .env:**
- API ключи в коде (секреты в Git!)
- Разные настройки для dev/production хардкодом
- Нельзя менять настройки без изменения кода

**Environment Variables решают:**
- ✅ Секреты вне кода (.env.local не в Git)
- ✅ Разные настройки для dev/production
- ✅ Легко менять без изменения кода

---

#### 📐 Типы переменных в Next.js

**КРИТИЧНО понимать:**

```
┌─────────────────────────────────────────────────────────┐
│  СЕРВЕРНЫЕ ПЕРЕМЕННЫЕ                                    │
│  (только на сервере, клиент НЕ видит)                   │
│                                                          │
│  DATABASE_URL=postgresql://...                          │
│  API_SECRET_KEY=sk_...                                  │
│  STRIPE_SECRET_KEY=sk_...                               │
│                                                          │
│  ✅ Безопасно (секреты)                                  │
│  ❌ НЕ доступны в browser                                │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│  КЛИЕНТСКИЕ ПЕРЕМЕННЫЕ                                   │
│  (доступны в browser, префикс NEXT_PUBLIC_)             │
│                                                          │
│  NEXT_PUBLIC_API_URL=https://api.example.com            │
│  NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_...              │
│                                                          │
│  ⚠️ Видны в browser (не для секретов!)                  │
│  ✅ Нужны для frontend логики                            │
└─────────────────────────────────────────────────────────┘
```

**Правило:**
- Без `NEXT_PUBLIC_` → только сервер
- С `NEXT_PUBLIC_` → сервер + клиент (browser)

---

#### 🔐 Файлы .env

**Next.js поддерживает несколько .env файлов:**

```
.env                  # Для всех окружений (common)
.env.local            # Локальная разработка (в .gitignore)
.env.development      # npm run dev
.env.production       # npm run build + npm start
```

**Приоритет (от высшего к низшему):**
1. `.env.local` (highest priority)
2. `.env.development` или `.env.production`
3. `.env`

**Что использовать:**
- `.env.local` - для разработки (секреты, локальные настройки)
- `.env.example` - шаблон (БЕЗ реальных значений, в Git)

---

#### 📝 Пример .env.local

```env
# Database (только сервер)
DATABASE_URL=postgresql://user:password@localhost:5432/mydb

# Authentication (Clerk)
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_...
CLERK_SECRET_KEY=sk_test_...

# Stripe
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_...
STRIPE_SECRET_KEY=sk_test_...

# OpenAI (только сервер)
OPENAI_API_KEY=sk-...

# App URL (клиент)
NEXT_PUBLIC_APP_URL=http://localhost:3000
```

---

#### 📝 Пример .env.example

```env
# Database
DATABASE_URL=postgresql://user:password@localhost:5432/mydb

# Authentication (get from: https://clerk.com)
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_...
CLERK_SECRET_KEY=sk_test_...

# Stripe (get from: https://stripe.com/dashboard)
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_...
STRIPE_SECRET_KEY=sk_test_...

# OpenAI
OPENAI_API_KEY=sk-...

# App URL
NEXT_PUBLIC_APP_URL=http://localhost:3000
```

---

#### 💻 Использование переменных

**В Server Components / API Routes (сервер):**

```tsx
// app/api/posts/route.ts
export async function GET() {
  // Серверная переменная (БЕЗ NEXT_PUBLIC_)
  const dbUrl = process.env.DATABASE_URL
  const apiKey = process.env.OPENAI_API_KEY
  
  // Работает ✅
  return Response.json({ connected: true })
}
```

---

**В Client Components (браузер):**

```tsx
// app/components/SomeComponent.tsx
'use client'

export default function SomeComponent() {
  // Клиентская переменная (С NEXT_PUBLIC_)
  const apiUrl = process.env.NEXT_PUBLIC_APP_URL
  
  // ✅ Работает
  console.log('API URL:', apiUrl)
  
  // ❌ НЕ работает (undefined)
  const dbUrl = process.env.DATABASE_URL
  console.log('DB URL:', dbUrl) // undefined
  
  return <div>Component</div>
}
```

**⚠️ ВАЖНО:** Серверные переменные недоступны в Client Components!

---

#### 🔧 Type Safety (TypeScript)

**Создай типы для переменных:**

```tsx
// src/lib/env.ts
export const env = {
  // Серверные
  DATABASE_URL: process.env.DATABASE_URL!,
  OPENAI_API_KEY: process.env.OPENAI_API_KEY!,
  CLERK_SECRET_KEY: process.env.CLERK_SECRET_KEY!,
  
  // Клиентские
  NEXT_PUBLIC_APP_URL: process.env.NEXT_PUBLIC_APP_URL!,
  NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: process.env.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY!,
}

// Валидация при старте
if (!env.DATABASE_URL) {
  throw new Error('DATABASE_URL is not defined')
}
```

**Использование:**

```tsx
import { env } from '@/lib/env'

const dbUrl = env.DATABASE_URL // Type-safe ✅
```

---

#### ⚠️ Безопасность

**DO (делай так):**

✅ **Секреты в .env.local (не в коде)**
```tsx
// ✅ Правильно
const apiKey = process.env.OPENAI_API_KEY

// ❌ Неправильно (хардкод)
const apiKey = 'sk-abc123...'
```

✅ **Клиентские переменные ТОЛЬКО для публичной информации**
```env
# ✅ OK для NEXT_PUBLIC_
NEXT_PUBLIC_APP_URL=https://myapp.com
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_live_...

# ❌ НИКОГДА не делай NEXT_PUBLIC_ для секретов
NEXT_PUBLIC_DATABASE_PASSWORD=...  # ❌ Опасно!
```

✅ **.env.local в .gitignore**
```gitignore
.env*.local
```

---

**DON'T (не делай так):**

❌ **Серверные секреты с NEXT_PUBLIC_**
```env
# ❌ ОПАСНО - секрет будет в браузере!
NEXT_PUBLIC_DATABASE_URL=postgresql://...
NEXT_PUBLIC_API_SECRET=sk-...
```

❌ **.env.local в Git**
```bash
# ❌ НЕ делай
git add .env.local
```

❌ **Хардкод секретов в коде**
```tsx
// ❌ Секрет в коде (попадёт в Git)
const apiKey = 'sk-abc123xyz'
```

---

#### 🔄 Перезапуск после изменений

**⚠️ ВАЖНО:** Next.js требует перезапуска после изменения .env!

```bash
# Изменил .env.local
# Останови сервер (Ctrl+C)
# Запусти заново
npm run dev
```

**Не работает Hot Reload для .env файлов!**

---

#### ✅ Чек-лист: Variables настроены

**Файлы созданы:**
- [ ] .env.local создан (для разработки)
- [ ] .env.example создан (шаблон для Git)
- [ ] .gitignore содержит .env*.local

**Переменные правильно названы:**
- [ ] Серверные БЕЗ NEXT_PUBLIC_
- [ ] Клиентские С NEXT_PUBLIC_
- [ ] Нет секретов в NEXT_PUBLIC_

**Безопасность:**
- [ ] .env.local НЕ в Git
- [ ] Нет хардкода секретов в коде
- [ ] .env.example БЕЗ реальных значений

**Проверка:**
- [ ] Серверные переменные работают в API routes
- [ ] Клиентские переменные работают в Client Components
- [ ] После изменения .env перезапускаешь сервер

---

**Следующий урок:** 3.4 Чек-лист: Next.js проект готов