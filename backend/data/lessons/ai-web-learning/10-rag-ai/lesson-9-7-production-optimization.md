# Урок 9.7: Production оптимизация и масштабирование

> **Модуль 9:** RAG + AI Агент  
> **Урок:** 9.7  
> **Длительность:** 2-3 часа  
> **Prerequisite:** Урок 9.6

---

## 🎯 Цели урока

После этого урока ты сможешь:
- ✅ Настроить мониторинг затрат и метрик
- ✅ Реализовать rate limiting для защиты бюджета
- ✅ Обработать ошибки API корректно
- ✅ Масштабировать систему при росте студентов
- ✅ Выбрать когда переходить на премиум модели
- ✅ Подготовить AI агента к production deployment

---

## 📖 Часть 1: Мониторинг затрат

### Что мониторить?

**Простое определение:**
Мониторинг = отслеживание метрик для контроля расходов и качества.

### Аналогия: Мониторинг как приборная панель автомобиля

```
┌────────────────────────────────────────┐
│      ПРИБОРНАЯ ПАНЕЛЬ AI АГЕНТА        │
├────────────────────────────────────────┤
│                                        │
│  💰 Спидометр расходов:                │
│     ┌─────────────────────┐           │
│     │ $8.50 / $20 лимит   │           │
│     │ ████░░░░░░░░ 42%    │           │
│     └─────────────────────┘           │
│                                        │
│  ⏱️ Тахометр производительности:       │
│     ┌─────────────────────┐           │
│     │ TTFT: 850ms         │           │
│     │ Tokens/sec: 45      │           │
│     └─────────────────────┘           │
│                                        │
│  📊 Одометр кэша:                      │
│     ┌─────────────────────┐           │
│     │ Cache hits: 78%     │           │
│     │ Saved: $6.20        │           │
│     └─────────────────────┘           │
│                                        │
│  ⚠️ Индикаторы проблем:                │
│     🟢 API Status: OK                  │
│     🟢 Error Rate: 0.5%                │
│     🟡 Rate Limits: 85% used           │
│                                        │
└────────────────────────────────────────┘
```

**Зачем нужна панель:**
- Видишь сколько тратишь (до превышения бюджета)
- Замечаешь проблемы (медленно, ошибки)
- Контролируешь качество (кэш работает?)

---

### Ключевые метрики

**1. Финансовые метрики:**

```
Cost Per Query (CPQ) = Общая стоимость / Количество запросов

Целевые значения:
├─ С кэшем: $0.03-0.10 за запрос ✅
└─ Без кэша: $0.10-0.15 за запрос ⚠️

Cost Per Student Per Month (CPSM) = Стоимость / Студентов

Целевые значения:
├─ Gemini 2.5 Flash: $2.90-3.50/студент ✅
├─ GPT-4.1 Mini: $5.40-6.50/студент ⚠️
└─ Claude Sonnet 4.5: $7.30-9.50/студент ⚠️

Cache Hit Rate = Кэш-хиты / Всего запросов

Целевые значения:
├─ Отлично: >80% ✅
├─ Хорошо: 70-80% ✅
├─ Плохо: <60% ❌ (нужна оптимизация)
```

**2. Производительность:**

```
Time to First Token (TTFT)
├─ p50 (медиана): <800ms ✅
├─ p95 (95 перцентиль): <1500ms ✅
└─ p99: <2000ms ✅

Если хуже → студенты ждут долго → плохой UX

Total Latency (время от вопроса до ответа)
├─ Целевое: <3 секунды ✅
└─ Критичное: >5 секунд ❌
```

**3. Качество:**

```
Student Satisfaction Score
├─ Оценка студентов: 1-5 звёзд
├─ Цель: >4.0 из 5 ✅
└─ Если <3.5 → качество ответов недостаточное

Answer Accuracy
├─ % корректных ответов
├─ Проверка вручную на сэмпле
└─ Цель: >85% правильных ответов

Context Retrieval Success
├─ % вопросов где AI нашёл информацию в курсе
├─ Для Long Context должно быть ~100%
└─ Если <90% → проблема с промптом или курсом
```

---

### Работа с Claude Code: Создание dashboard

**Диалог:**

```
Ты: Claude, создай простой dashboard для мониторинга AI агента

Требования:
1. Новая страница в Streamlit: monitoring_dashboard.py
2. Читать логи из backend/logs/chat.log
3. Показывать метрики:
   - Общая стоимость за сегодня/неделю/месяц
   - Cache hit rate
   - Средняя латентность (TTFT)
   - Error rate
4. Графики: расходы по времени, cache hits по часам
5. Использовать pandas для обработки логов

Claude Code: Отличная задача! Создам dashboard.

Что будет сделано:
✓ Создан monitoring_dashboard.py
✓ Функция load_logs() для парсинга chat.log
✓ Расчёт метрик через pandas
✓ Визуализация с st.line_chart(), st.metric()
✓ Фильтры по датам
✓ Auto-refresh каждые 30 секунд

Применить?

Ты: Y

Claude Code: ✓ Dashboard создан
             
             Запустить:
             streamlit run monitoring_dashboard.py
             
             Откроется на http://localhost:8502
```

**Результат:** Визуальный контроль затрат в реальном времени!

---

## 🛡️ Часть 2: Rate Limiting и защита бюджета

### Что такое Rate Limiting?

**Простое определение:**
Rate Limiting = ограничение количества запросов в единицу времени.

### Аналогия: Rate Limiting как турникет в метро

```
┌──────────────────────────────────────┐
│         ТУРНИКЕТ API (Rate Limiter)  │
├──────────────────────────────────────┤
│                                      │
│  Правило: Максимум 10 человек/минуту│
│                                      │
│  Студент 1: ✅ Проход разрешён       │
│  Студент 2: ✅ Проход разрешён       │
│  ...                                 │
│  Студент 10: ✅ Проход разрешён      │
│  Студент 11: ❌ Подождите минуту!    │
│                                      │
│  Защищает от:                        │
│  ├─ Spam атак                        │
│  ├─ Случайных ошибок в цикле         │
│  └─ Превышения бюджета               │
│                                      │
└──────────────────────────────────────┘
```

**Зачем нужно:**
- Защита от runaway costs (бесконтрольных затрат)
- Справедливое распределение ресурсов между студентами
- Соответствие лимитам API провайдера

---

### Уровни Rate Limiting

**1. На уровне провайдера (Google AI):**

```
Free Tier:
├─ 15 RPM (requests per minute)
├─ 250K TPM (tokens per minute)
└─ Автоматически блокирует при превышении

Tier 1 ($250+ spending):
├─ 1,000 RPM ✅
├─ Достаточно для 100 студентов
└─ Апгрейд по мере роста
```

**2. На уровне приложения (твой backend):**

```
По пользователю:
├─ 10 запросов в минуту
└─ Защита от одного спамера

По всему приложению:
├─ Дневной бюджет: $20
└─ Если превышен → временное отключение
```

---

### Работа с Claude Code: Реализация лимитов

**Диалог:**

```
Ты: Claude, добавь многоуровневую защиту от превышения бюджета

Требования:
1. Rate limiting на endpoint (10 req/min на пользователя)
2. Дневной бюджет $20 - если превышен, отключаем API
3. Алерты при достижении 80% дневного бюджета
4. Graceful degradation (показывать сообщение студенту)

Claude Code: Отличная защита! Реализую в несколько шагов.

Шаг 1: Rate limiting через slowapi

Что сделаю:
✓ Установка slowapi
✓ Добавление в main.py
✓ Декоратор @limiter.limit("10/minute")
✓ Custom error handler для 429

Применить?

Ты: Y

Claude Code: ✓ Rate limiting работает

Шаг 2: Budget checker

Что сделаю:
✓ Создам budget_checker.py
✓ Функция check_daily_budget() читает логи
✓ Считает расходы за сегодня
✓ Если >$20 → raise BudgetExceededError
✓ Middleware в main.py проверяет перед запросом

Применить?

Ты: Y

Claude Code: ✓ Budget checker добавлен

Шаг 3: Алерты

Что сделаю:
✓ При 80% бюджета → warning в логи
✓ При 100% → error + отключение API
✓ Email уведомления (опционально)

Применить?

Ту: Y

Claude Code: ✓ Все уровни защиты активны
             
             Тестирование:
             - Попробуй отправить 11 запросов подряд
             - 11-й вернёт 429 Too Many Requests
             - Установи дневной бюджет $0.50 для теста
             - После превышения API вернёт 503 Budget Exceeded
```

**Результат:** Трёхуровневая защита от runaway costs

---

## 🔧 Часть 3: Обработка ошибок

### Типичные ошибки API

**1. Rate Limit Exceeded (429)**

```
Причина: Слишком много запросов к Gemini API
Решение: 
├─ Exponential backoff (повторить через 1, 2, 4, 8 сек)
├─ Очередь запросов на твоей стороне
└─ Апгрейд до Tier 1 (больше RPM)
```

**2. Context Length Exceeded**

```
Причина: Курс + история + вопрос > 1M токенов
Решение:
├─ Суммировать историю диалога
├─ Удалять старые сообщения
└─ Использовать модель с большим контекстом (Gemini 2M)
```

**3. API Key Invalid**

```
Причина: Неправильный или устаревший ключ
Решение:
├─ Проверить .env файл
├─ Сгенерировать новый ключ в AI Studio
└─ Проверить expiration date
```

**4. Service Unavailable (503)**

```
Причина: Google AI Studio временно недоступен
Решение:
├─ Retry с exponential backoff
├─ Fallback на другую модель (GPT-4.1 Mini)
└─ Показать студенту friendly сообщение
```

---

### Работа с Claude Code: Robust error handling

**Диалог:**

```
Ты: Claude, улучши обработку ошибок в gemini_client.py

Требования:
1. Обработать все типичные ошибки Gemini API
2. Exponential backoff для 429 и 503
3. Fallback на GPT-4.1 Mini при длительном outage Gemini
4. Логировать все ошибки
5. Возвращать студенту понятные сообщения

Claude Code: Отлично! Сделаю надёжную обработку.

Изменения в gemini_client.py:
✓ Try-except блоки для каждого типа ошибки
✓ Функция retry_with_backoff() для 429/503
✓ Максимум 3 попытки с задержками 1, 2, 4 секунды
✓ Если все попытки failed → fallback_to_gpt()
✓ Дружелюбные сообщения для студентов

Применить?

Ты: Y

Claude Code: ✓ Error handling улучшен

Теперь в chat.py:
✓ Обёртка try-except вокруг ask()
✓ Разные HTTP коды для разных ошибок
✓ 429 → "Слишком много запросов, попробуйте через минуту"
✓ 503 → "Сервис временно недоступен, используем альтернативную модель"
✓ 500 → "Произошла ошибка, мы уже работаем над этим"

Применить?

Ты: Y

Claude Code: ✓ Готово! Все ошибки обрабатываются корректно.
```

**Результат:** Студенты получают понятные сообщения вместо stack traces

---

## 📈 Часть 4: Масштабирование системы

### Когда пора масштабировать?

**Сигналы для upgrade:**

```
🟡 ПРЕДУПРЕЖДЕНИЯ (пора планировать):
├─ Error rate >3% из-за rate limits
├─ TTFT p95 >2 секунды (студенты ждут долго)
├─ Cache hit rate <60% (плохая оптимизация)
├─ Cost per student >$10/месяц (дорого)
└─ >50 студентов на Free Tier

🔴 КРИТИЧНО (действовать срочно):
├─ Error rate >10%
├─ TTFT p95 >5 секунд
├─ Cost per student >$15/месяц
├─ Жалобы студентов на медленную работу
└─ >100 студентов, все на Free Tier
```

---

### Пороги масштабирования

| Студентов | Рекомендация | Стоимость/мес |
|-----------|--------------|---------------|
| <50 | Free Tier + Gemini Flash | $0-150 |
| 50-100 | Tier 1 + кэширование | $150-350 |
| 100-300 | Tier 1 + агрессивная оптимизация | $350-900 |
| 300-500 | Tier 2 + hybrid модели | $900-2,000 |
| >500 | Переговоры с Google или self-hosting | $2,000+ |

---

### Стратегии масштабирования

**1. Вертикальное (Tier Upgrade)**

**Работа с Claude Code:**

```
Ты: Claude, добавь автоматический мониторинг tier limits

Требования:
1. Отслеживать текущий tier и его лимиты
2. При достижении 90% RPM → warning в логи
3. Расчёт когда нужен upgrade
4. Инструкции для апгрейда в README

Claude Code: Создам tier_monitor.py

Функции:
✓ get_current_tier() - определяет tier по API key
✓ get_usage_stats() - RPM/TPM текущие
✓ calculate_headroom() - сколько осталось до лимита
✓ recommend_upgrade() - когда пора upgrade

Применить?

Ты: Y

Claude Code: ✓ Мониторинг tier готов
             ✓ Добавлен в dashboard
```

**2. Горизонтальное (Multiple API keys)**

```
Стратегия: Несколько проектов в Google AI
├─ Project 1: 1,000 RPM
├─ Project 2: 1,000 RPM
└─ Round-robin между ключами = 2,000 RPM эффективно
```

**3. Hybrid подход (Cheap + Premium)**

```
IF вопрос простой (определения, факты):
   → Gemini 2.5 Flash ($2.90/студент)
ELSE IF средняя сложность:
   → GPT-4.1 Mini ($5.40/студент)
ELSE IF сложный (дебаг кода, архитектура):
   → Claude Sonnet 4.5 ($7.30/студент)

Экономия: Используй дорогую модель только когда нужно
```

---

## 🎯 Часть 5: Когда переходить на премиум модели

### Сравнение моделей для разных задач

**Простые вопросы (60% трафика):**
```
"Что такое FastAPI?"
"Как создать переменную в Python?"

Gemini 2.5 Flash: ✅ Справляется отлично
Переход на премиум: ❌ Не нужен
```

**Средние вопросы (30% трафика):**
```
"Сравни FastAPI и Django REST Framework"
"Объясни разницу между SSR и CSR"

Gemini 2.5 Flash: ✅ Хорошо
GPT-4.1 Mini: ✅ Чуть лучше
Переход: ⚠️ Опционально
```

**Сложные вопросы (10% трафика):**
```
"Найди ошибку в моём коде для async обработки"
"Спроектируй архитектуру для e-commerce с ML"

Gemini 2.5 Flash: ⚠️ Средне
Claude Sonnet 4.5: ✅ Отлично
Переход: ✅ Рекомендуется для продвинутых студентов
```

---

### Работа с Claude Code: Routing между моделями

**Диалог:**

```
Ты: Claude, реализуй умный routing - простые вопросы на Gemini,
    сложные на Claude Sonnet 4.5

Требования:
1. Классификатор сложности вопроса (простой/средний/сложный)
2. Роутинг на основе классификации
3. Логирование какая модель использовалась
4. Расчёт экономии

Claude Code: Интересная задача! Создам model_router.py

Компоненты:
✓ Функция classify_question() - анализирует вопрос
✓ Правила: длина >200 символов + код + debug → сложный
✓ Класс MultiModelClient с Gemini + Claude
✓ Метод route_and_ask() выбирает модель
✓ Fallback если одна модель недоступна

Применить?

Ты: Y

Claude Code: ✓ Model router готов

Настройка в chat.py:
✓ Заменил GeminiClient на MultiModelClient
✓ Автоматический routing активен
✓ Логи показывают: question_complexity и selected_model

Применить?

Ты: Y

Claude Code: ✓ Умный routing работает!

             Экономия (оценка):
             60% простых ($2.90) + 30% средних ($3.50) + 10% сложных ($7.30)
             = $3.65/студент вместо $7.30 при использовании только Claude
             Экономия: $3.65/студент × 100 = $365/месяц!
```

**Результат:** Оптимальное использование каждой модели

---

## 📝 Резюме урока

### Что настроили для Production

```
✅ Мониторинг:
   ├─ Dashboard с метриками
   ├─ Отслеживание затрат
   └─ Cache hit rate, латентность

✅ Защита бюджета:
   ├─ Rate limiting (10 req/min)
   ├─ Дневной бюджет ($20)
   └─ Алерты при 80%

✅ Error handling:
   ├─ Retry с exponential backoff
   ├─ Fallback на другую модель
   └─ Понятные сообщения студентам

✅ Масштабирование:
   ├─ Мониторинг tier limits
   ├─ Hybrid модели (дешёвая + премиум)
   └─ Рекомендации по upgrade
```

### Пороги для действий

```
При 50 студентах:
└─ Upgrade Tier 1 ($250+ spending)

При 100 студентах:
└─ Агрессивная оптимизация кэша

При 300 студентах:
├─ Hybrid routing (Gemini + Claude)
└─ Tier 2 или multiple API keys

При 500+ студентах:
└─ Переговоры с Google или self-hosting Llama
```

---

## ❓ Вопросы для самопроверки

1. **Какие три уровня защиты от runaway costs?**
   - Ответ: Rate limiting, дневной бюджет, алерты при 80%

2. **Что делать если Error rate >10%?**
   - Ответ: Upgrade tier, добавить retry logic, проверить error handling

3. **Когда использовать премиум модели?**
   - Ответ: Для сложных вопросов (дебаг кода, архитектура), ~10% трафика

4. **Как экономить при 100 студентах?**
   - Ответ: Prompt caching (90% скидка), hybrid routing, tier 1 upgrade

5. **При каком количестве студентов нужен Tier 2?**
   - Ответ: 300-500 студентов, когда Tier 1 (1,000 RPM) недостаточно

---

## 🔗 Связь с другими уроками

**Основано на уроках:**
- Урок 9.5: Выбрали Gemini 2.5 Flash
- Урок 9.6: Создали AI агента

**Завершает модуль:**
- Модуль 9 полностью изучен
- AI агент готов к production

**Связь с проектом:**
Твой AI агент теперь production-ready! Настроен мониторинг, защита бюджета, обработка ошибок. Готов к запуску для 50-100 студентов с возможностью масштабирования.

---

## ✅ Критерии завершения урока

**Мониторинг:**
- [ ] Создал dashboard с метриками
- [ ] Логи записываются корректно
- [ ] Могу отслеживать затраты

**Защита:**
- [ ] Rate limiting работает (10 req/min)
- [ ] Дневной бюджет настроен
- [ ] Алерты при превышении 80%

**Error handling:**
- [ ] Обрабатываются 429, 503, другие ошибки
- [ ] Retry с exponential backoff
- [ ] Fallback модель настроена

**Масштабирование:**
- [ ] Понимаю когда нужен upgrade
- [ ] Знаю как масштабировать до 500+ студентов
- [ ] Hybrid routing настроен (опционально)

**Production готовность:**
- [ ] Всё протестировано
- [ ] Документация обновлена
- [ ] Готов к deploy

---

## 🛠️ Практическое задание

### Задача: Подготовить AI агента к production

**Шаг 1: Мониторинг (1 час)**
- Создай dashboard с Claude Code
- Настрой логирование метрик
- Проверь cache hit rate >70%

**Шаг 2: Защита (1 час)**
- Добавь rate limiting
- Настрой дневной бюджет $20
- Протестируй что работает

**Шаг 3: Error handling (30 минут)**
- Улучши обработку ошибок
- Добавь retry logic
- Протестируй 429, 503 ошибки

**Шаг 4: Stress test (30 минут)**
- Отправь 100 запросов подряд
- Проверь rate limiting
- Посмотри метрики в dashboard
- Рассчитай стоимость

**Ожидаемый результат:**
- ✅ Dashboard показывает метрики
- ✅ Rate limiting защищает от spam
- ✅ Бюджет контролируется
- ✅ Ошибки обрабатываются gracefully
- ✅ Готов к production deployment!

---

**Статус урока:** ⏸️ Не начат  
**Модуль 9 завершён:** После этого урока ✅

**Конец урока 9.7 и Модуля 9** ✅

🎉 **Поздравляю! Модуль 9: RAG + AI Агент полностью завершён!**

Теперь у тебя есть production-ready AI агент для образовательной платформы с:
- Длинным контекстом (весь курс 350K токенов)
- Prompt caching (экономия 90%)
- Streamlit MVP и React+FastAPI production версия
- Полным мониторингом и защитой бюджета
- Готовностью к масштабированию до 500+ студентов

**Следующие шаги:**
1. Изучить созданные материалы
2. Реализовать AI агента для своего курса
3. Протестировать на реальных студентах
4. Масштабировать по мере роста

**Успехов в создании интерактивной образовательной платформы! 🚀**