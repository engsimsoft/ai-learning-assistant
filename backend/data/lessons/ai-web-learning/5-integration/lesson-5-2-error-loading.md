# Урок 5.2: Обработка ошибок и Loading states - Профессиональный UX

> **Модуль 5:** Интеграция Frontend-Backend  
> **Урок:** 5.2  
> **Длительность:** 50-60 минут  
> **Prerequisite:** Урок 5.1 (Соединение Frontend-Backend)

---

## 🎯 Цели урока

После этого урока ты сможешь:
- ✅ Понимать важность error handling для UX
- ✅ Знать типы ошибок и как их обрабатывать
- ✅ Создавать профессиональные loading states
- ✅ Использовать optimistic updates
- ✅ Сформулировать задачу для Claude Code с правильным error handling
- ✅ Применить для EngineCamPro v2

---

## 📖 Концепция: Зачем нужна обработка ошибок

### Простое определение

**Error Handling** - правильная обработка и отображение ошибок пользователю.

**Loading States** - показ процесса выполнения операции пользователю.

### Зачем это нужно

Без error handling и loading states:
- ❌ Пользователь не понимает что происходит
- ❌ Приложение выглядит сломанным
- ❌ Невозможно понять причину проблемы
- ❌ Плохой UX = пользователи уходят

С правильной обработкой:
- ✅ Пользователь всегда знает что происходит
- ✅ Понятные сообщения об ошибках
- ✅ Можно исправить проблему
- ✅ Профессиональный UX

### 🚦 Аналогия: GPS навигатор

```
┌─────────────────────────────────────────────────┐
│      БЕЗ ОБРАБОТКИ = ПЛОХОЙ GPS                  │
├─────────────────────────────────────────────────┤
│                                                 │
│  Ты едешь и вдруг:                              │
│                                                 │
│  📱 Экран пустой                                 │
│  🤔 Что происходит?                              │
│     - GPS грузит? Или сломался?                 │
│     - Потерян сигнал? Или всё OK?               │
│     - Надо ждать? Или перезапустить?            │
│                                                 │
│  ❌ Полная неопределённость                     │
│  ❌ Стресс и фрустрация                         │
│  ❌ Не знаешь что делать                        │
│                                                 │
└─────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────┐
│      С ОБРАБОТКОЙ = ХОРОШИЙ GPS                  │
├─────────────────────────────────────────────────┤
│                                                 │
│  📱 LOADING STATE:                               │
│     🔄 "Поиск спутников..."                      │
│     → Ты знаешь: система работает, нужно ждать  │
│                                                 │
│  📱 ERROR STATE (нет сигнала):                   │
│     ❌ "GPS сигнал потерян"                      │
│     💡 "Выйдите на открытое пространство"       │
│     🔄 "Повторить попытку"                       │
│     → Ты знаешь: что случилось и что делать     │
│                                                 │
│  📱 ERROR STATE (нет интернета):                 │
│     ❌ "Нет подключения к интернету"             │
│     💡 "Проверьте WiFi или мобильные данные"    │
│     📍 "Работаем в оффлайн режиме"              │
│     → Ты знаешь: причина и альтернатива         │
│                                                 │
│  ✅ Понятность                                   │
│  ✅ Контроль ситуации                           │
│  ✅ Знаешь что делать                           │
│                                                 │
└─────────────────────────────────────────────────┘
```

---

## 🚨 Типы ошибок

### 1. Network Errors (сетевые ошибки)

**Причины:**
- Backend выключен
- Нет интернета
- Timeout (слишком долгий ответ)

**Как обрабатывать:**
```
❌ Плохо:
"Error"

✅ Хорошо:
"Не удалось подключиться к серверу"
💡 "Проверьте интернет-соединение"
🔄 Кнопка "Повторить попытку"
```

### 2. Validation Errors (422)

**Причины:**
- Неправильные входные данные
- Backend не прошёл Pydantic валидацию

**Как обрабатывать:**
```
❌ Плохо:
"Validation error"

✅ Хорошо:
"Некорректные параметры:"
• base_radius должен быть больше 0
• lift не может быть больше base_radius
→ Подсветить красным проблемные поля
```

### 3. Not Found (404)

**Причины:**
- Запрошенный ресурс не существует
- Неправильный ID

**Как обрабатывать:**
```
❌ Плохо:
"404"

✅ Хорошо:
"Кулачок с ID 123 не найден"
💡 "Возможно, он был удалён"
🏠 Кнопка "На главную"
```

### 4. Server Errors (500)

**Причины:**
- Ошибка в backend коде
- Проблема с базой данных
- Ошибка в расчётах

**Как обрабатывать:**
```
❌ Плохо:
"Internal Server Error"

✅ Хорошо:
"Произошла ошибка при расчёте"
💡 "Попробуйте изменить параметры"
📧 "Если проблема повторяется - свяжитесь с поддержкой"
```

---

## ⏳ Loading States

### Типы loading состояний

```
┌─────────────────────────────────────────────────┐
│           ТИПЫ LOADING STATES                    │
├─────────────────────────────────────────────────┤
│                                                 │
│  1️⃣ SPINNER (крутящийся индикатор)              │
│     🔄 Универсальный, для любых операций        │
│     Используй когда: время загрузки неизвестно  │
│                                                 │
│  2️⃣ PROGRESS BAR (прогресс-бар)                 │
│     ████████░░░░ 80%                            │
│     Используй когда: можешь отследить прогресс  │
│                                                 │
│  3️⃣ SKELETON (скелетон экран)                   │
│     ▂▂▂▂ ▂▂▂▂▂▂                                │
│     ▂▂▂ ▂▂▂▂▂                                  │
│     Используй когда: загрузка списков/карточек  │
│                                                 │
│  4️⃣ INLINE TEXT (текст)                         │
│     "Загрузка..."                               │
│     Используй когда: минималистичный дизайн     │
│                                                 │
│  5️⃣ DISABLED STATE (отключённое состояние)      │
│     [Кнопка серая и неактивна]                  │
│     Используй всегда: disable кнопки при loading│
│                                                 │
└─────────────────────────────────────────────────┘
```

### Для EngineCamPro

```
Операция: Расчёт профиля кулачка

Loading State:
┌─────────────────────────────────────┐
│  🔄 Выполняется расчёт...            │
│                                     │
│  [Форма остаётся видимой]           │
│  [Кнопка "Calculate" disabled]      │
│  [Spinner рядом с кнопкой]          │
│                                     │
│  График: [Skeleton placeholder]     │
│                                     │
└─────────────────────────────────────┘

Успех:
┌─────────────────────────────────────┐
│  ✅ Расчёт завершён                  │
│  [График появился плавно]           │
│  [Статистика отображена]            │
│  [Кнопка active снова]              │
└─────────────────────────────────────┘

Ошибка:
┌─────────────────────────────────────┐
│  ❌ Ошибка расчёта                   │
│  💡 Проверьте параметры              │
│  🔄 Попробовать снова                │
└─────────────────────────────────────┘
```

---

## 💡 Паттерны error handling в React

### Паттерн 1: Try-Catch + State

```
function CamCalculator() {
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState(null)
  const [result, setResult] = useState(null)
  
  const calculate = async (params) => {
    setLoading(true)
    setError(null)  // Очистить предыдущую ошибку
    
    try {
      const data = await camAPI.calculate(params)
      setResult(data)
    } catch (err) {
      // Обработка разных типов ошибок
      if (err.message.includes('Network')) {
        setError('Нет связи с сервером. Проверьте интернет.')
      } else if (err.status === 422) {
        setError('Некорректные параметры. Проверьте ввод.')
      } else {
        setError('Произошла ошибка. Попробуйте позже.')
      }
    } finally {
      setLoading(false)  // Всегда выполнится
    }
  }
  
  return (
    <>
      {loading && <Spinner />}
      {error && <ErrorMessage text={error} onRetry={calculate} />}
      {result && <ProfileChart data={result} />}
    </>
  )
}
```

### Паттерн 2: Error Boundary (для критичных ошибок)

```
Для ошибок которые ломают весь компонент:

class ErrorBoundary extends React.Component {
  state = { hasError: false }
  
  static getDerivedStateFromError(error) {
    return { hasError: true }
  }
  
  render() {
    if (this.state.hasError) {
      return (
        <div>
          <h1>Что-то пошло не так</h1>
          <button onClick={() => window.location.reload()}>
            Перезагрузить
          </button>
        </div>
      )
    }
    return this.props.children
  }
}

// Использование
<ErrorBoundary>
  <App />
</ErrorBoundary>
```

### Паттерн 3: Toast Notifications

```
Для некритичных уведомлений:

import { toast } from 'sonner' // или react-hot-toast

const handleSave = async () => {
  try {
    await saveData()
    toast.success('Сохранено успешно! ✅')
  } catch (error) {
    toast.error('Ошибка сохранения ❌')
  }
}

Преимущества:
✅ Не блокирует UI
✅ Автоматически исчезает
✅ Можно показать несколько одновременно
```

---

## 🎨 UX принципы

### 1. Немедленная обратная связь

```
❌ Плохо:
User нажал кнопку
→ 2 секунды тишины
→ Результат появился

✅ Хорошо:
User нажал кнопку
→ Мгновенно: кнопка disable, spinner появился
→ 2 секунды: spinner крутится
→ Результат появился, spinner исчез
```

### 2. Понятные сообщения

```
❌ Избегай технического жаргона:
"ECONNREFUSED"
"HTTP 500 Internal Server Error"
"Unhandled Promise Rejection"

✅ Используй человеческий язык:
"Не удалось подключиться к серверу"
"Ошибка обработки запроса"
"Что-то пошло не так"
```

### 3. Предложи решение

```
Каждая ошибка должна содержать:

1. ЧТО произошло
   "Не удалось загрузить данные"

2. ПОЧЕМУ (если знаем)
   "Сервер не отвечает"

3. ЧТО ДЕЛАТЬ
   🔄 "Попробовать снова"
   💡 "Проверьте интернет"
   📧 "Свяжитесь с поддержкой"
```

### 4. Оптимистичные обновления

```
Optimistic UI - обновляем UI сразу, не дожидаясь ответа

Пример: Лайк поста
❌ Медленно:
Click → Wait 2s → Server response → UI updates

✅ Быстро (Optimistic):
Click → UI updates сразу (лайк появился)
       → Server request в фоне
       → Если ошибка - откатить изменения

Преимущества:
✅ Мгновенный отклик
✅ Кажется быстрее
✅ Лучший UX
```

---

## 🤖 Работа с Claude Code

### Сценарий: Улучшение error handling

#### ✅ Эффективный диалог

```
Ты: Улучши error handling и loading states в EngineCamPro 
React приложении.

Требования к Error Handling:

1. Типы ошибок для обработки:
   - Network errors (backend недоступен)
   - Validation errors (422)
   - Not found (404)
   - Server errors (500)
   - Timeout (>10 секунд)

2. Error State в компонентах:
   const [error, setError] = useState(null)
   
   Структура error объекта:
   {
     type: 'network' | 'validation' | 'server',
     message: string,
     details?: string[],
     canRetry: boolean
   }

3. Компонент <ErrorMessage />:
   Props:
   - error: объект ошибки
   - onRetry?: функция повтора
   - onDismiss?: функция закрытия
   
   UI:
   - Icon соответствующий типу (❌ 🔄 ⚠️)
   - Заголовок понятный
   - Описание проблемы
   - Кнопка "Retry" если canRetry
   - Кнопка закрытия (X)
   - Tailwind стили (красный для error, жёлтый для warning)

4. API Service обновление:
   Функция parseError(response):
   - Проверить status code
   - Распарсить error message от backend
   - Вернуть структурированный error объект
   
   Все API функции должны:
   - throw структурированные ошибки
   - Логировать ошибки в console
   - Добавить timeout (10 секунд)

─────────────────────────────────────

Требования к Loading States:

1. Loading State в компонентах:
   const [loading, setLoading] = useState(false)
   
   Типы loading:
   - isCalculating: boolean
   - isSaving: boolean
   - isLoadingHistory: boolean

2. Компонент <Spinner />:
   Variants:
   - sm: маленький (inline в тексте)
   - md: средний (рядом с кнопкой)
   - lg: большой (центр экрана)
   - fullscreen: на весь экран с overlay
   
   Props:
   - size: 'sm' | 'md' | 'lg'
   - text?: string (опциональный текст)
   
   Tailwind animation для вращения

3. Компонент <SkeletonLoader />:
   Для загрузки графиков и карточек
   
   Variants:
   - chart: прямоугольник для графика
   - card: карточка результата
   - list: список элементов
   
   Tailwind animate-pulse

4. Button States:
   - Обычное состояние
   - Loading: disabled + spinner + текст "Loading..."
   - Disabled: серый, cursor not-allowed
   - Success flash: кратковременно зелёный после успеха

5. Прогресс индикаторы:
   Для long-running операций (>3 секунды):
   - Показать прогресс если возможно
   - Или показать этапы: "Валидация... → Расчёт... → Готово"

─────────────────────────────────────

Интеграция в CamCalculator:

1. Форма:
   - Disable inputs при loading
   - Показать spinner на кнопке
   - Очистить предыдущие ошибки при новом расчёте

2. График:
   - Skeleton пока грузится
   - Плавное появление (fade-in) после загрузки
   - Error state если данные не загрузились

3. Результаты:
   - Skeleton для карточек статистики
   - Animated counter для чисел (опционально)

4. Retry логика:
   - При network error: автоматический retry через 3s (1 раз)
   - При других ошибках: кнопка ручного retry
   - Exponential backoff для повторных попыток

5. Toast notifications:
   - Установить sonner или react-hot-toast
   - Success: зелёный toast "Расчёт завершён ✅"
   - Error: красный toast с кратким описанием
   - Position: bottom-right
   - Auto-dismiss: 5 секунд

Claude Code: [анализирует требования]

Улучшу error handling и loading states:

Создам/обновлю:
1. src/components/ErrorMessage.jsx
2. src/components/Spinner.jsx
3. src/components/SkeletonLoader.jsx
4. src/services/api.js (добавлю parseError, timeout)
5. src/hooks/useCamCalculation.js (улучшу error handling)
6. Обновлю CamCalculator для интеграции

Установлю:
- sonner для toast notifications

Применить? [Y/n]

Ты: Y

Claude Code: [создаёт компоненты и улучшает логику]

Готово! Улучшения:

Error Handling:
✅ Структурированные ошибки (type, message, details)
✅ ErrorMessage компонент с retry
✅ parseError в API service
✅ Timeout 10 секунд
✅ Понятные сообщения на русском

Loading States:
✅ Spinner компонент (3 размера)
✅ SkeletonLoader для графика
✅ Button loading states
✅ Disable формы при loading

Toast Notifications:
✅ sonner установлен
✅ Success и error toasts
✅ Auto-dismiss 5s

UX улучшения:
✅ Плавные transitions
✅ Optimistic updates для некритичных операций
✅ Автоматический retry для network errors
✅ Clear error на новый запрос

Протестируй:
1. Выключи backend → Network error с retry
2. Введи невалидные данные → Validation error
3. Нажми Calculate → Loading states
4. Успешный расчёт → Success toast

Хочешь что-то ещё?

Ты: Добавь Error Boundary для всего приложения

Claude Code: [создаёт ErrorBoundary компонент]
Создан ErrorBoundary:
- Перехватывает критичные ошибки
- Показывает fallback UI
- Кнопка "Перезагрузить приложение"
- Логирование ошибок в console
- Обёрнут весь <App /> в main.jsx
```

**Почему это эффективно:**
- ✅ Все типы ошибок описаны
- ✅ Структура error объекта чёткая
- ✅ Компоненты с вариантами (variants)
- ✅ Loading states для разных сценариев
- ✅ Toast notifications для UX
- ✅ Retry логика встроена
- ✅ Error Boundary для критичных ошибок

---

## 🛠️ Практическое задание

### Задача

Улучши существующее приложение EngineCamPro с профессиональным error handling и loading states.

### Работа с Claude Code

Используй диалог из секции выше и адаптируй под своё приложение.

### Тестирование

**Сценарии для проверки:**

1. **Network Error:**
   - Выключи backend
   - Нажми Calculate
   - Должен показаться: "Нет связи с сервером" + Retry

2. **Validation Error:**
   - Введи base_radius = -10
   - Нажми Calculate
   - Должен показаться: "Некорректные параметры" + детали

3. **Loading State:**
   - Backend включен
   - Нажми Calculate
   - Должно показаться: spinner, disabled кнопка, skeleton

4. **Success:**
   - Всё правильно введено
   - Нажми Calculate
   - Должно: loading → success toast → график

5. **Auto Retry:**
   - Backend выключен
   - Нажми Calculate
   - Включи backend в течение 3 секунд
   - Должно: auto retry → success

### Ожидаемый результат

- ✅ Все ошибки обрабатываются
- ✅ Loading states профессиональны
- ✅ UX плавный и понятный
- ✅ Retry логика работает
- ✅ Toast notifications показываются

---

## ❓ Вопросы для самопроверки

1. **Зачем нужен error handling?**
   - Что будет без него?
   - Какой UX эффект?

2. **Типы ошибок:**
   - Какие бывают?
   - Как обрабатывать каждый?

3. **Loading states:**
   - Какие типы индикаторов?
   - Когда использовать каждый?

4. **UX принципы:**
   - Что такое немедленная обратная связь?
   - Зачем Optimistic UI?

5. **Для EngineCamPro v2:**
   - Какие ошибки могут возникнуть?
   - Как показывать loading?
   - Когда использовать toast vs inline error?

---

## 🔗 Связь с другими уроками

**Основано на уроках:**
- Урок 5.1: Интеграция - теперь улучшаем UX

**Подготавливает к урокам:**
- Урок 5.3: State Management - сложное управление
- Модуль 6: Монетизация - error handling для auth

**Связь с EngineCamPro:**
Профессиональный UX делает приложение:
- Понятным для пользователей
- Надёжным при ошибках
- Приятным в использовании

---

## ✅ Критерии завершения урока

**Понимание концепций:**
- [ ] Понимаю важность error handling
- [ ] Знаю типы ошибок
- [ ] Понимаю loading states
- [ ] Знаю UX принципы

**Практические навыки:**
- [ ] Могу обрабатывать ошибки правильно
- [ ] Могу создать loading states
- [ ] Понимаю retry логику
- [ ] Знаю когда использовать toast

**Готовность к следующему уроку:**
- [ ] Улучшен error handling
- [ ] Добавлены loading states
- [ ] UX стал профессиональнее
- [ ] Готов к State Management

---

**Статус урока:** ⏳ Не начат / 🔄 В процессе / ✅ Завершён  
**Дата начала:** _________  
**Дата завершения:** _________