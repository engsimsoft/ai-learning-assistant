# Урок 10.1: Введение в ML - Добавляем "мозги" в веб-приложение

> **Модуль 10:** Machine Learning для веб-приложений (ОПЦИОНАЛЬНЫЙ)  
> **Урок:** 10.1  
> **Длительность:** 50-60 минут  
> **Prerequisite:** Модуль 2 (Backend FastAPI)

---

## 🎯 Цели урока

После этого урока ты сможешь:

- Понимать что такое Machine Learning простыми словами
- Определять когда ML нужен в веб-приложении, а когда достаточно обычного кода
- Интегрировать простую ML модель в FastAPI backend
- Формулировать задачи для Claude Code при работе с ML проектами
- Понимать базовую архитектуру ML в веб-приложениях

---

## 📖 Концепция: Что такое Machine Learning

### Простое определение

**Machine Learning (ML)** - это когда программа учится выполнять задачу на примерах, вместо того чтобы ты писал для неё детальные инструкции.

### Зачем это нужно?

Представь задачу: определить спам или не спам в письме. 

**Традиционный подход (без ML):**
```
ЕСЛИ письмо содержит "бесплатно" → спам
ЕСЛИ письмо содержит "выиграл миллион" → спам
ЕСЛИ письмо содержит "кликни здесь" → спам
...
```

❌ Проблема: Нужно написать тысячи правил  
❌ Спамеры обходят правила  
❌ Не учитывает контекст  

**С Machine Learning:**
```
1. Показываешь модели 10000 примеров:
   - 5000 писем-спама
   - 5000 нормальных писем

2. Модель САМА находит паттерны:
   - Какие слова чаще в спаме
   - Какие комбинации слов подозрительны
   - Структура подозрительных писем

3. Теперь модель может определять спам в новых письмах
```

✅ Не нужно писать правила вручную  
✅ Модель учится на примерах  
✅ Адаптируется к новым типам спама  

---

### 🏪 Аналогия: Обучение сотрудника vs ML

**Ситуация:** Нужен сотрудник, который сортирует клиентские запросы.

**БЕЗ ML (традиционное программирование):**
```
┌─────────────────────────────────┐
│  Ты пишешь инструкцию:          │
│                                 │
│  ЕСЛИ клиент написал "цена"     │
│    → направить в отдел продаж   │
│                                 │
│  ЕСЛИ клиент написал "не работает"│
│    → направить в техподдержку   │
│                                 │
│  ЕСЛИ клиент написал "возврат"  │
│    → направить в финансы        │
│                                 │
│  ...1000 правил if-else...      │
└─────────────────────────────────┘
```

❌ Нужно предусмотреть ВСЕ случаи  
❌ Клиенты формулируют по-разному  
❌ Постоянно добавляешь новые правила  

**С ML:**
```
┌─────────────────────────────────┐
│  Ты показываешь примеры:        │
│                                 │
│  "Сколько стоит?" → отдел продаж│
│  "Почему дорого?" → отдел продаж│
│  "Цена?" → отдел продаж         │
│                                 │
│  "Сломалось" → техподдержка     │
│  "Ошибка 404" → техподдержка    │
│  "Не включается" → техподдержка │
│                                 │
│  ...10000 примеров...           │
│                                 │
│  Модель САМА понимает паттерны! │
└─────────────────────────────────┘
```

✅ Учится на примерах  
✅ Понимает разные формулировки  
✅ Чем больше примеров - тем умнее  

---

## 💡 Типы ML задач для веб-приложений

### 1. **Классификация (Classification)**

**Что это:** Разделить данные по категориям.

**Примеры:**
- 📧 **Спам или не спам** в письме
- 🐱 **Кот или собака** на фото
- ⭐ **Положительный или негативный** отзыв
- 🚨 **Мошенническая или честная** транзакция

**Когда использовать:**  
Когда нужно определить к какой категории относится объект.

**Пример в веб-приложении:**
```
User загружает фото → POST /api/classify-pet
Backend с ML моделью → {"animal": "cat", "confidence": 0.95}
Frontend показывает → "Это кот! 🐱 (уверенность 95%)"
```

---

### 2. **Регрессия (Regression)**

**Что это:** Предсказать числовое значение.

**Примеры:**
- 🏠 **Цена дома** по параметрам (площадь, район, год)
- 📈 **Продажи в следующем месяце** по истории
- 🌡️ **Температура завтра** по метеоданным
- 💰 **Стоимость доставки** по весу и расстоянию

**Когда использовать:**  
Когда нужно предсказать число, а не категорию.

**Пример в веб-приложении:**
```
User вводит параметры → POST /api/predict-price
Backend с ML моделью → {"predicted_price": 285000}
Frontend показывает → "Примерная цена дома: $285,000"
```

---

### 3. **Рекомендации (Recommendation)**

**Что это:** Предложить похожие или интересные объекты.

**Примеры:**
- 🎬 **Фильмы** как в Netflix ("Похожие фильмы")
- 🛒 **Товары** как на Amazon ("Вам может понравиться")
- 🎵 **Музыка** как в Spotify ("Рекомендации для вас")
- 📰 **Статьи** как в Medium ("Читать дальше")

**Когда использовать:**  
Когда нужно персонализировать опыт пользователя.

**Пример в веб-приложении:**
```
User смотрит товар → GET /api/recommendations?product_id=123
Backend с ML моделью → {"recommendations": [456, 789, 234]}
Frontend показывает → "Вам может понравиться:" + карточки товаров
```

---

## 🔧 Когда добавлять ML в веб-приложение

### ✅ ML НУЖЕН когда:

1. **Есть паттерны в данных, но не очевидные правила**
   - Пример: Определить какие клиенты уйдут к конкурентам
   - ❌ Нельзя написать простое правило
   - ✅ Есть сложные закономерности в поведении

2. **Много примеров для обучения (>1000 записей)**
   - Пример: У тебя 10000 фотографий котов и собак
   - ✅ Модель может обучиться на примерах

3. **Нужны предсказания или рекомендации**
   - Пример: Предсказать спрос на товар
   - Пример: Рекомендовать похожие продукты

4. **Задача слишком сложна для if-else**
   - Пример: Распознавание лиц на фото
   - Пример: Определение тональности текста

---

### ❌ ML НЕ НУЖЕН когда:

1. **Простые правила (if-else достаточно)**
   - Пример: ❌ ML для определения чётности числа - это перебор! 😄
   - Пример: ❌ ML для расчёта скидки (if total > 100 → discount 10%)

2. **Мало данных (<100 записей)**
   - У тебя 50 примеров → Модель НЕ научится хорошо
   - Нужны тысячи примеров для качественного обучения

3. **Нужна 100% точность**
   - Медицина: определение болезни
   - Финансы: критичные транзакции
   - ML всегда имеет погрешность!

4. **Простые CRUD операции**
   - Создать/прочитать/обновить/удалить запись
   - Для этого есть база данных, ML не нужен

---

### 🎯 Практические примеры:

| Задача | Решение | Почему? |
|--------|---------|---------|
| Рекомендации товаров | ✅ ML | Сложные паттерны в поведении |
| Валидация email формата | ❌ Regex | Простое правило |
| Предсказание оттока клиентов | ✅ ML | Много факторов, паттерны |
| Расчёт суммы заказа | ❌ Арифметика | Простое сложение |
| Определение языка текста | ✅ ML | Сложные паттерны |
| Проверка что возраст >18 | ❌ If-else | Простое сравнение |
| Распознавание речи | ✅ ML | Очень сложная задача |
| Сортировка списка | ❌ Алгоритм | Есть стандартные решения |

---

## 🐍 ML библиотеки для Python

### **scikit-learn** (рекомендуется для начала)

**Что это:**  
Простая библиотека для классических ML задач.

**Плюсы:**
- ✅ Много готовых алгоритмов "из коробки"
- ✅ Простой API, легко начать
- ✅ Идеально для типичных задач
- ✅ Отличная документация

**Когда использовать:**
- Классификация (спам/не спам)
- Регрессия (предсказание цен)
- Кластеризация (группировка похожих объектов)
- Рекомендации (похожие товары)

**Пример задач:**
```
✅ Предсказать цену дома
✅ Определить спам
✅ Рекомендовать товары
✅ Классифицировать отзывы (позитивный/негативный)
```

---

### **TensorFlow / PyTorch** (для продвинутых задач)

**Что это:**  
Библиотеки для Deep Learning (глубокое обучение, нейронные сети).

**Плюсы:**
- ✅ Мощные возможности для сложных задач
- ✅ Нейронные сети
- ✅ Работа с изображениями, текстом, видео

**Минусы:**
- ⚠️ Сложнее в изучении
- ⚠️ Требует больше данных
- ⚠️ Требует мощное железо (GPU)

**Когда использовать:**
- Распознавание изображений (не простая классификация)
- Обработка естественного языка (NLP)
- Генерация текста/изображений
- Сложные паттерны

---

### 🎯 Для веб-приложений:

**Начни с scikit-learn:**
- 90% задач в веб-приложениях решаются scikit-learn
- Быстрее разработка
- Проще интеграция
- Меньше требований к железу

**Переходи на TensorFlow/PyTorch когда:**
- Нужна работа с изображениями высокой сложности
- Нужна обработка текста (анализ больших текстов)
- scikit-learn не справляется с задачей

---

## 🌐 Интеграция ML в FastAPI

### Архитектура

```
┌──────────────────────────────────────────────────┐
│              FRONTEND (React)                    │
│                                                  │
│  User вводит данные:                             │
│  - Площадь дома: 120 кв.м                        │
│  - Комнаты: 3                                    │
│  - Год постройки: 2010                           │
│                                                  │
│  [Кнопка "Рассчитать цену"]                      │
└─────────────────┬────────────────────────────────┘
                  │
                  │ POST /api/predict-price
                  │ {
                  │   "area": 120,
                  │   "rooms": 3,
                  │   "year": 2010
                  │ }
                  ↓
┌──────────────────────────────────────────────────┐
│         BACKEND (FastAPI)                        │
│                                                  │
│  ┌──────────────────────────────────┐            │
│  │ 1. Получить данные               │            │
│  │    (валидация через Pydantic)    │            │
│  └──────────┬───────────────────────┘            │
│             │                                    │
│             ↓                                    │
│  ┌──────────────────────────────────┐            │
│  │ 2. Предобработать                │            │
│  │    (нормализация, проверки)      │            │
│  └──────────┬───────────────────────┘            │
│             │                                    │
│             ↓                                    │
│  ┌──────────────────────────────────┐            │
│  │ 3. ML модель предсказывает       │            │
│  │    📦 model.predict([120,3,2010])│            │
│  │    → predicted_price = 285000    │            │
│  └──────────┬───────────────────────┘            │
│             │                                    │
│             ↓                                    │
│  ┌──────────────────────────────────┐            │
│  │ 4. Вернуть результат             │            │
│  │    {"predicted_price": 285000}   │            │
│  └──────────────────────────────────┘            │
│                                                  │
│  ┌────────────────────────────────┐              │
│  │  📦 ML MODEL (scikit-learn)    │              │
│  │                                │              │
│  │  - Загружена при старте app    │              │
│  │  - Хранится в памяти           │              │
│  │  - Быстрые предсказания        │              │
│  └────────────────────────────────┘              │
│                                                  │
└──────────────────┬───────────────────────────────┘
                   │
                   │ Response: {"predicted_price": 285000}
                   ↓
┌──────────────────────────────────────────────────┐
│              FRONTEND (React)                    │
│                                                  │
│  Показать результат:                             │
│  "Примерная цена: $285,000"                      │
│                                                  │
└──────────────────────────────────────────────────┘
```

---

### ⚙️ Важные моменты архитектуры:

**1. Модель загружается ОДИН раз при старте приложения**
```
✅ Правильно:
app startup → загрузить модель → хранить в памяти
каждый запрос → использовать готовую модель (быстро!)

❌ Неправильно:
каждый запрос → загрузить модель → использовать → удалить
(медленно, нагрузка на сервер!)
```

**2. Модель кэшируется в памяти**
```
Модель один раз в RAM → быстрый доступ
```

**3. Предобработка данных**
```
User вводит: "120" (строка)
Backend: конвертация → 120 (число) + валидация
Модель: получает корректные числа
```

---

## 🤖 Работа с Claude Code

Вот как формулировать задачи для Claude Code при добавлении ML:

### Сценарий: Добавление простой ML модели в FastAPI

```
┌─────────────────────────────────────────────────┐
│  ТЫ:                                            │
└─────────────────────────────────────────────────┘

Добавь ML модель для предсказания цены дома в FastAPI backend.

Требования:

Backend:
- Установить scikit-learn
- Создать endpoint POST /api/predict-price
- Входные данные: площадь (area), количество комнат (rooms), год постройки (year)
- Использовать Linear Regression модель
- Обучить на тестовых данных (для демо, 100 примеров)
- Вернуть предсказанную цену

Структура:
- app/ml/model.py - код модели и обучение
- app/ml/data.py - тестовые данные для обучения
- app/routers/ml.py - endpoint для предсказаний
- Загрузить модель при старте приложения в main.py

Endpoint:
- Pydantic модель для входных данных (HousePredictionInput)
- Валидация: площадь > 0, комнаты > 0, год 1900-2025
- Error handling для всех случаев
- Вернуть JSON: {"predicted_price": 285000, "confidence": "medium"}

Best practices:
- Модель обучается только при старте, не при каждом запросе
- Кэширование модели в памяти
- Логирование предсказаний
- Документация endpoint в Swagger

┌─────────────────────────────────────────────────┐
│  CLAUDE CODE:                                   │
└─────────────────────────────────────────────────┘

Создам ML интеграцию для предсказания цены дома:

Структура:
✅ requirements.txt - добавлю scikit-learn, numpy, pandas
✅ app/ml/data.py - сгенерирую 100 тестовых примеров
✅ app/ml/model.py - Linear Regression, обучение, сохранение
✅ app/routers/ml.py - endpoint POST /api/predict-price
✅ app/schemas/ml.py - Pydantic модели
✅ app/main.py - загрузка модели при старте

Особенности реализации:
- Модель обучается при старте app
- Сохраняется в app.state.ml_model
- Быстрые предсказания (модель в RAM)
- Валидация через Pydantic
- Error handling + логирование
- Swagger docs автоматически

Применить изменения? [Y/n]

┌─────────────────────────────────────────────────┐
│  ТЫ: Y                                          │
└─────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────┐
│  CLAUDE CODE:                                   │
└─────────────────────────────────────────────────┘

✅ Создал app/ml/data.py
   - Функция generate_sample_data()
   - 100 примеров домов (площадь, комнаты, год, цена)

✅ Создал app/ml/model.py
   - Класс HousePriceModel
   - Обучение Linear Regression
   - Метод predict()
   - Оценка качества модели

✅ Создал app/routers/ml.py
   - POST /api/predict-price
   - Валидация данных
   - Error handling
   - Логирование

✅ Обновил app/main.py
   - Загрузка модели при startup
   - Хранение в app.state

✅ Добавил в requirements.txt:
   scikit-learn==1.3.0
   numpy==1.24.3
   pandas==2.0.3

Модель обучена! Точность: R² = 0.92 (отличный результат)

Хочешь протестировать через curl?

┌─────────────────────────────────────────────────┐
│  ТЫ: Да                                         │
└─────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────┐
│  CLAUDE CODE:                                   │
└─────────────────────────────────────────────────┘

Запусти сервер:
```bash
uvicorn app.main:app --reload
```

Тестовый запрос:
```bash
curl -X POST "http://localhost:8000/api/predict-price" \
  -H "Content-Type: application/json" \
  -d '{
    "area": 120,
    "rooms": 3,
    "year": 2010
  }'
```

Ожидаемый ответ:
```json
{
  "predicted_price": 285000,
  "confidence": "medium",
  "input": {
    "area": 120,
    "rooms": 3,
    "year": 2010
  }
}
```

Также доступна документация: http://localhost:8000/docs
Там можно протестировать endpoint интерактивно!

Хочешь добавить frontend для визуализации предсказаний?
```

---

### 💡 Что важно в диалоге:

1. **Чёткая формулировка задачи:**
   - Какой тип ML (классификация/регрессия)
   - Какие данные (входные/выходные)
   - Какой результат ожидается

2. **Указание best practices:**
   - Загрузка модели при старте
   - Кэширование
   - Error handling
   - Валидация

3. **Структура проекта:**
   - Где код модели
   - Где данные
   - Где endpoints

4. **Итеративное улучшение:**
   - Сначала базовая версия
   - Потом тестирование
   - Потом frontend (опционально)

---

## 🛠️ Практическое задание

### Задача:
Добавь простой ML endpoint в своё приложение (или создай новое FastAPI приложение для практики).

### Выбери один вариант:

#### **Вариант 1: Предсказание цены (Regression)**
```
Входные данные:
- Площадь товара/дома (число)
- Категория (1-5)
- Возраст (лет)

Выход:
- Предсказанная цена
```

#### **Вариант 2: Классификация спама (Classification)**
```
Входные данные:
- Текст сообщения (строка)

Выход:
- Спам или не спам
- Уверенность (0-100%)
```

#### **Вариант 3: Рекомендация похожих товаров (Similarity)**
```
Входные данные:
- ID товара

Выход:
- Список из 5 похожих товаров
```

---

### Инструкции:

**Шаг 1: Формулировка для Claude Code**

Создай чёткую формулировку задачи, включающую:
- Тип ML задачи
- Входные/выходные данные
- Фреймворк (FastAPI + scikit-learn)
- Best practices
- Структуру проекта

**Шаг 2: Создание через Claude Code**

Используй Claude Code CLI для создания проекта:
```bash
claude-code "создай FastAPI проект с ML моделью для [твоя задача]"
```

**Шаг 3: Тестирование**

- Запусти сервер: `uvicorn app.main:app --reload`
- Открой Swagger docs: `http://localhost:8000/docs`
- Протестируй endpoint с разными данными
- Проверь обработку ошибок (неверные данные)

**Шаг 4: Анализ**

Ответь на вопросы:
- Где в коде загружается модель?
- Когда она обучается?
- Как происходит предсказание?
- Как обрабатываются ошибки?

---

### ✅ Критерии успеха:

- [ ] Модель загружается при старте приложения
- [ ] Endpoint работает корректно
- [ ] Валидация входных данных работает
- [ ] Error handling на месте
- [ ] Можешь протестировать через Swagger docs
- [ ] Понимаешь как работает каждая часть системы

---

## ⚠️ Важные предупреждения

### ❌ Что НЕ делать:

**1. НЕ обучай модель при каждом запросе**
```python
# ❌ ПЛОХО - медленно и расточительно!
@app.post("/predict")
def predict(data: Input):
    model = train_model()  # Обучение при КАЖДОМ запросе!
    return model.predict(data)

# ✅ ХОРОШО - обучение один раз при старте
@app.on_event("startup")
def startup():
    app.state.model = train_model()  # Один раз!

@app.post("/predict")
def predict(data: Input):
    return app.state.model.predict(data)  # Быстро!
```

**2. НЕ храни большие модели в Git**
```
❌ Не добавляй в Git:
- model.pkl (может быть >100MB)
- training_data.csv (большие датасеты)

✅ Используй:
- .gitignore для model.pkl
- Облачное хранилище (S3, Google Cloud Storage)
- Model registry (MLflow, DVC)
```

**3. НЕ используй ML где достаточно простых правил**
```
❌ Плохо:
ML модель для проверки что число чётное

✅ Хорошо:
if number % 2 == 0  # Просто!
```

**4. НЕ ожидай 100% точности**
```
ML всегда имеет погрешность!
- Regression: может ошибиться на ±10%
- Classification: может дать неверный ответ
```

---

### ✅ Best Practices:

**1. Обучай модель отдельно, загружай при старте**
```
Правильный workflow:

1. Обучение (отдельный скрипт):
   python train_model.py
   → Сохранить model.pkl

2. Production (FastAPI):
   Загрузить model.pkl при startup
   → Использовать для предсказаний
```

**2. Кэшируй модель в памяти**
```python
# ✅ Модель в RAM - быстрый доступ
app.state.model = load_model("model.pkl")

# Каждый запрос использует одну и ту же модель из памяти
```

**3. Храни модели в облаке**
```
Вместо локального файла:
- AWS S3
- Google Cloud Storage
- Azure Blob Storage

При деплое:
- Скачать модель из облака
- Загрузить в память
- Использовать для предсказаний
```

**4. Версионируй модели**
```
Правильная структура:
models/
  ├── house_price_v1.pkl
  ├── house_price_v2.pkl  # Улучшенная модель
  └── house_price_v3.pkl  # Текущая

Можно откатиться к старой версии при проблемах!
```

**5. Мониторь точность в production**
```
Логируй:
- Входные данные
- Предсказания модели
- Реальные результаты (если доступны)

Анализируй:
- Деградирует ли качество со временем?
- Какие предсказания ошибочны?
- Когда нужно переобучить модель?
```

---

## 🔗 Связь с другими уроками

### Основано на:

- **Модуль 2: Backend FastAPI**
  - ML интегрируется в FastAPI через endpoints
  - Используем Pydantic для валидации
  - Асинхронная обработка запросов

- **Модуль 5: Интеграция Frontend + Backend** (опционально)
  - ML endpoint вызывается из React
  - Fetch API для отправки данных
  - Отображение предсказаний в UI

### Связь с проектами:

- **EngineCamPro** (из курса):
  - Можно добавить предсказание оптимальных параметров двигателя
  - ML модель на основе истории измерений
  - Рекомендации по настройкам

- **Модуль 9: RAG системы** (если будет в курсе):
  - ML используется для создания embeddings (векторные представления)
  - Семантический поиск документов
  - Продвинутое применение ML

---

## ❓ Вопросы для самопроверки

Ответь на вопросы своими словами (без поиска в материалах!):

### 1. Объясни ML через аналогию
```
Придумай свою аналогию (не из урока):
Что такое Machine Learning?
```

### 2. Когда нужен ML?
```
Задача: Определить является ли пользователь VIP клиентом.

Когда использовать ML?
Когда использовать if-else?
```

### 3. Какую библиотеку выбрать?
```
У тебя задача: классификация отзывов (позитивный/негативный).
Какую библиотеку выбрать: scikit-learn или TensorFlow?
Почему?
```

### 4. Архитектура ML в FastAPI
```
Где в FastAPI должна загружаться ML модель?
Почему нельзя загружать её при каждом запросе?
```

### 5. Формулировка задачи для Claude Code
```
Напиши запрос для Claude Code:
Нужен endpoint для предсказания рейтинга фильма (1-10 звёзд)
на основе жанра, года выпуска, бюджета.

Что важно указать в запросе?
```

---

## ✅ Критерии завершения урока

Отметь после выполнения:

- [ ] Понимаю что такое ML своими словами
- [ ] Могу объяснить когда нужен ML, а когда достаточно if-else
- [ ] Знаю разницу между scikit-learn и TensorFlow
- [ ] Понимаю как интегрировать ML в FastAPI
- [ ] Знаю что модель загружается при старте, а не при каждом запросе
- [ ] Могу сформулировать задачу для Claude Code с ML
- [ ] Выполнил практическое задание
- [ ] Протестировал endpoint через Swagger docs

---

## 🎓 Что дальше?

Ты освоил базовую интеграцию ML в веб-приложения! 

### Куда двигаться:

**Если хочешь углубиться в ML:**
- Изучи больше алгоритмов scikit-learn
- Попробуй разные типы моделей (Random Forest, SVM, Neural Networks)
- Научись оценивать качество моделей (метрики accuracy, precision, recall)

**Если хочешь продолжить веб-разработку:**
- Вернись к основному курсу (Модуль 3, 4, 5...)
- Интегрируй ML в свои проекты по мере необходимости
- ML - это мощный инструмент, но не обязательный для каждого проекта!

**Следующие опциональные темы:**
- Деплой ML моделей в production
- Мониторинг и версионирование моделей
- Работа с большими данными
- Deep Learning для специфичных задач

---

## 💬 Обратная связь

Этот урок опциональный и экспериментальный!

Если что-то непонятно или хочешь больше примеров - задавай вопросы.

ML - это не магия, это просто ещё один инструмент в твоём арсенале веб-разработчика. 🚀