# Урок 2.2: HTTP методы и endpoints

> **Модуль 2:** Backend разработка  
> **Урок:** 2.2  
> **Длительность:** 45-60 минут  
> **Prerequisite:** Урок 2.1 (Введение в FastAPI)

---

## 🎯 Цели урока

После этого урока ты сможешь:
- ✅ Понимать разницу между GET, POST, PUT, DELETE
- ✅ Знать когда какой HTTP метод использовать
- ✅ Проектировать RESTful URL структуру
- ✅ Создавать CRUD endpoints через диалог с Claude Code
- ✅ Применять best practices для URL дизайна

---

## 📖 Концепция: HTTP методы

### Простое определение

**HTTP методы** (или глаголы) - это способы указать серверу ЧТО ты хочешь сделать с ресурсом. Это как глаголы в предложении: "прочитай", "создай", "обнови", "удали".

### Зачем это нужно

Без стандартных методов каждый разработчик изобретал бы свои URL:
- `/get_cam?id=1`
- `/create_new_cam`
- `/update_cam_data?id=1`
- `/delete_cam_permanently?id=1`

**Проблема:** Хаос! Каждый API разный, нет стандарта.

**Решение:** HTTP методы + RESTful URLs = понятный и предсказуемый API.

### 🍽️ Аналогия: Кафе с системой заказов

Представь кафе где ты пишешь записки повару:

```
БЕЗ HTTP МЕТОДОВ (хаос)
═══════════════════════

📝 "Покажи мне меню блюда номер 5"
📝 "Сделай новое блюдо: пицца Маргарита"
📝 "Поменяй блюдо 5 на пиццу Пепперони"
📝 "Убери блюдо номер 5 из меню"

Повар в замешательстве! 😵


С HTTP МЕТОДАМИ (стандарт)
═══════════════════════════

📋 МЕНЮ (ресурс): /menu/pizza/5

GET    /menu/pizza/5  ➜ "Покажи мне"
POST   /menu/pizza    ➜ "Создай новую"
PUT    /menu/pizza/5  ➜ "Замени полностью"
DELETE /menu/pizza/5  ➜ "Удали"

Повар понимает моментально! ✅
```

**HTTP методы = стандартизированные глаголы:**
- 👁️ **GET** - "Покажи мне" (читай)
- ➕ **POST** - "Создай новое" (создай)
- 🔄 **PUT** - "Замени полностью" (обнови всё)
- 🗑️ **DELETE** - "Удали" (удали)

### Как работает

```
┌──────────────────────────────────────────────────────────┐
│                   HTTP ЗАПРОС                            │
│                                                          │
│   МЕТОД  +  URL  +  ДАННЫЕ (опционально)                │
│     ↓       ↓         ↓                                  │
│   GET   /api/cams/123   [нет данных]                    │
│                                                          │
│         Метод говорит ЧТО делать                         │
│         URL говорит С ЧЕМ работать                       │
│                                                          │
└──────────────────────────────────────────────────────────┘

Примеры:

GET    /api/cams/123    ➜ Получи кулачок #123
POST   /api/cams        ➜ Создай новый кулачок
PUT    /api/cams/123    ➜ Обнови кулачок #123
DELETE /api/cams/123    ➜ Удали кулачок #123
```

---

## 💡 Четыре основных HTTP метода

### 1. GET - Чтение данных 👁️

**Что делает:** Получает данные, НЕ изменяет ничего на сервере

**Характеристики:**
- **Безопасный:** Не меняет данные (safe)
- **Идемпотентный:** Можно вызывать много раз, результат одинаковый
- **Кэшируемый:** Браузер может сохранить ответ

**Примеры:**
```
GET /api/cams           ➜ Получить список всех кулачков
GET /api/cams/5         ➜ Получить кулачок с ID=5
GET /api/cams/5/profile ➜ Получить профиль кулачка #5
GET /api/projects       ➜ Получить список проектов
```

**Когда использовать:**
- ✅ Чтение данных
- ✅ Поиск и фильтрация
- ✅ Просмотр информации
- ❌ НЕ для изменения данных!

### 2. POST - Создание нового ➕

**Что делает:** Создаёт новый ресурс на сервере

**Характеристики:**
- **НЕ безопасный:** Изменяет данные
- **НЕ идемпотентный:** Каждый вызов создаёт новый ресурс
- **НЕ кэшируемый**

**Примеры:**
```
POST /api/cams
Body: {
  "name": "Intake Cam",
  "base_radius": 25,
  "lift": 10
}
➜ Создаёт новый кулачок, возвращает ID

POST /api/cams/5/calculate
Body: {"duration": 120}
➜ Запускает расчёт профиля
```

**Когда использовать:**
- ✅ Создание нового ресурса
- ✅ Отправка данных на обработку
- ✅ Действия которые изменяют состояние
- ❌ НЕ для чтения данных!

### 3. PUT - Полное обновление 🔄

**Что делает:** Заменяет ресурс ПОЛНОСТЬЮ новыми данными

**Характеристики:**
- **НЕ безопасный:** Изменяет данные
- **Идемпотентный:** Повторные вызовы дают тот же результат
- **НЕ кэшируемый**

**Примеры:**
```
PUT /api/cams/5
Body: {
  "name": "Updated Cam",
  "base_radius": 30,
  "lift": 12,
  "duration": 120
}
➜ Заменяет ВСЕ поля кулачка #5
```

**Когда использовать:**
- ✅ Полное обновление ресурса (все поля)
- ✅ Когда нужно заменить объект целиком
- ❌ НЕ для частичного обновления (используй PATCH)

### 4. DELETE - Удаление 🗑️

**Что делает:** Удаляет ресурс с сервера

**Характеристики:**
- **НЕ безопасный:** Изменяет данные (удаляет)
- **Идемпотентный:** Повторное удаление даёт тот же результат (404)
- **НЕ кэшируемый**

**Примеры:**
```
DELETE /api/cams/5      ➜ Удаляет кулачок #5
DELETE /api/projects/2  ➜ Удаляет проект #2
```

**Когда использовать:**
- ✅ Удаление ресурса
- ⚠️ Будь осторожен - действие необратимо!

---

## 🔄 CRUD и HTTP методы

**CRUD** - это четыре базовые операции с данными:

| CRUD Operation | HTTP Method | URL Example | Что делает |
|----------------|-------------|-------------|------------|
| **C**reate | POST | `POST /api/cams` | Создать новый кулачок |
| **R**ead (one) | GET | `GET /api/cams/5` | Получить кулачок #5 |
| **R**ead (all) | GET | `GET /api/cams` | Получить все кулачки |
| **U**pdate | PUT | `PUT /api/cams/5` | Обновить кулачок #5 |
| **D**elete | DELETE | `DELETE /api/cams/5` | Удалить кулачок #5 |

```
┌─────────────────────────────────────────────────────────────┐
│                 CRUD в EngineCamPro v2                      │
│                                                             │
│  CREATE  →  POST /api/cams                                  │
│             Body: {name, base_radius, lift, duration}       │
│             Response: {id: 123, ...}                        │
│                                                             │
│  READ    →  GET /api/cams/123                               │
│             Response: {id: 123, name: "Intake", ...}        │
│                                                             │
│  UPDATE  →  PUT /api/cams/123                               │
│             Body: {name, base_radius, lift, duration}       │
│             Response: {id: 123, ...}                        │
│                                                             │
│  DELETE  →  DELETE /api/cams/123                            │
│             Response: {message: "Deleted successfully"}     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 🎯 RESTful URL дизайн

### Принципы хороших URLs

#### ✅ ХОРОШИЕ URLs (RESTful)
```
/api/cams              ➜ Коллекция (список)
/api/cams/5            ➜ Конкретный ресурс
/api/cams/5/profile    ➜ Вложенный ресурс
/api/projects          ➜ Другая коллекция
/api/projects/2/cams   ➜ Кулачки проекта #2
```

**Правила:**
- ✅ Используй существительные во множественном числе
- ✅ Используй HTTP методы для действий
- ✅ Иерархия через `/`
- ✅ Lowercase с дефисами для читаемости

#### ❌ ПЛОХИЕ URLs (не RESTful)
```
/api/getCam?id=5       ➜ Глагол в URL (избыточно)
/api/createNewCam      ➜ Глагол в URL
/api/cam               ➜ Единственное число
/api/Cams              ➜ Заглавные буквы
/api/cams_list         ➜ Подчёркивания
```

### Шаблоны URLs для EngineCamPro v2

```
КОЛЛЕКЦИИ (списки)
GET    /api/cams              ➜ Список всех кулачков
POST   /api/cams              ➜ Создать новый кулачок

КОНКРЕТНЫЙ РЕСУРС
GET    /api/cams/{id}         ➜ Получить кулачок
PUT    /api/cams/{id}         ➜ Обновить кулачок
DELETE /api/cams/{id}         ➜ Удалить кулачок

ДЕЙСТВИЯ (специальные операции)
POST   /api/cams/{id}/calculate    ➜ Рассчитать профиль
GET    /api/cams/{id}/profile      ➜ Получить профиль

ВЛОЖЕННЫЕ РЕСУРСЫ
GET    /api/projects/{id}/cams     ➜ Кулачки проекта
POST   /api/projects/{id}/cams     ➜ Добавить кулачок в проект

ФИЛЬТРАЦИЯ (query параметры)
GET    /api/cams?project_id=2      ➜ Фильтр по проекту
GET    /api/cams?limit=10&offset=0 ➜ Пагинация
```

---

## 💡 Контекст применения

### Когда использовать RESTful подход?

**REST API идеален для:**
- ✅ **EngineCamPro v2** - Frontend/Backend разделены
- ✅ Доступ из разных клиентов (Web, Mobile, MATLAB)
- ✅ Публичное API для партнёров
- ✅ Микросервисная архитектура

**REST API НЕ нужен для:**
- ⚠️ Next.js Full-Stack - используй Server Actions
- ⚠️ Монолит где всё в одном процессе

### Для EngineCamPro v2: Почему REST?

```
✅ React Frontend общается с Python Backend
✅ Можно вызывать API из MATLAB scripts
✅ Swagger документация для пользователей
✅ Стандартная архитектура - легко понять
✅ Масштабируемость - можно добавить mobile app
```

---

## 🤖 Работа с Claude Code

### Задача: Создать CRUD endpoints для кулачков

### ❌ Плохой диалог (неэффективный)

```
Ты: Сделай CRUD для кулачков

Claude Code: Какие endpoints нужны?

Ты: Все

Claude Code: Какие поля у кулачка?

Ты: Не знаю
```

**Проблемы:**
- ❌ Неясная задача
- ❌ Нет структуры данных
- ❌ Много итераций на уточнение

### ✅ Хороший диалог (эффективный)

```bash
# Открой терминал в папке backend
cd ~/projects/enginecampro-v2/backend
claude
```

```
Ты: Привет! Продолжаем работу над EngineCamPro. Нужно создать CRUD 
endpoints для кулачков.

Claude Code: Отлично! Расскажи про структуру данных и какие endpoints нужны.

Ты: Создай CRUD endpoints для управления кулачками.

Структура данных (Pydantic модели):
```python
class CamBase:
    name: str
    base_radius: float  # мм
    lift: float         # мм
    duration: float     # градусы
    project_id: Optional[int]

class CamCreate(CamBase):
    pass

class CamUpdate(CamBase):
    pass

class CamResponse(CamBase):
    id: int
    created_at: datetime
```

Endpoints (RESTful):
- GET    /api/cams           ➜ Список всех кулачков (с пагинацией)
- GET    /api/cams/{id}      ➜ Получить конкретный кулачок
- POST   /api/cams           ➜ Создать новый кулачок
- PUT    /api/cams/{id}      ➜ Обновить кулачок
- DELETE /api/cams/{id}      ➜ Удалить кулачок

Требования:
- Следуй RESTful best practices
- Правильные HTTP статус коды:
  * 200 OK для GET/PUT/DELETE
  * 201 Created для POST
  * 404 Not Found если ресурс не найден
  * 422 Validation Error при неверных данных
- Pydantic валидация автоматически
- Type hints везде
- Пока без БД - храни в памяти (список словарей)

Структура файлов:
- app/models/cam.py      (Pydantic модели)
- app/routers/cams.py    (CRUD endpoints)
- app/main.py            (регистрация router)

Claude Code: Отлично! Создам CRUD API для кулачков.

Структура:
```
app/
├── models/
│   ├── __init__.py
│   └── cam.py          # Pydantic модели
├── routers/
│   ├── __init__.py
│   └── cams.py         # CRUD endpoints
└── main.py             # подключу router
```

Временное хранилище:
- Список в памяти `cams_db = []`
- Автоинкремент ID

Применить? [Y/n]

Ты: Y

Claude Code: ✅ Создал:
- app/models/cam.py (CamBase, CamCreate, CamUpdate, CamResponse)
- app/routers/cams.py (5 endpoints с правильными HTTP кодами)
- Обновил app/main.py (подключил cams router)

Endpoints готовы! Тестируй через Swagger:
http://localhost:8000/docs

Ты: Отлично! Теперь добавь фильтрацию по project_id и пагинацию 
для GET /api/cams

Claude Code: Добавлю query параметры:
- project_id: Optional[int] - фильтр по проекту
- limit: int = 10 - лимит результатов
- offset: int = 0 - смещение для пагинации

Обновлю endpoint GET /api/cams. Применить? [Y/n]

Ты: Y

Claude Code: ✅ Обновил GET /api/cams с фильтрацией и пагинацией.

Примеры использования:
- GET /api/cams                    ➜ Первые 10 кулачков
- GET /api/cams?limit=5            ➜ Первые 5
- GET /api/cams?offset=10&limit=5  ➜ Кулачки 11-15
- GET /api/cams?project_id=2       ➜ Только проекта #2

Ты: Проверю в Swagger. Спасибо!
```

**Почему это эффективно:**
- ✅ Чёткая структура данных с самого начала
- ✅ Все endpoints перечислены
- ✅ HTTP коды указаны
- ✅ RESTful best practices упомянуты
- ✅ Итеративное добавление функций (фильтрация)

---

## 🛠️ Практическое задание

### Задача

Создай полноценный CRUD API для кулачков через диалог с Claude Code. API должен поддерживать все основные операции и следовать RESTful принципам.

### Что нужно создать

- Pydantic модели для кулачков
- 5 CRUD endpoints (GET all, GET one, POST, PUT, DELETE)
- Фильтрация по project_id
- Пагинация (limit/offset)
- Правильные HTTP статус коды
- Временное хранилище в памяти

### Работа с Claude Code

**Шаг 1:** Открой терминал
```bash
cd ~/projects/enginecampro-v2/backend
claude
```

**Шаг 2:** Диалог с Claude Code

Используй шаблон хорошего диалога выше - адаптируй под себя:

```
Ты: Создай CRUD endpoints для управления кулачками.

[Укажи структуру данных]
[Укажи endpoints]
[Укажи требования]

Claude Code: [создаст файлы]

Ты: [итеративно добавляй функции]
```

**Шаг 3:** Запусти сервер
```bash
uvicorn app.main:app --reload
```

**Шаг 4:** Тестирование в Swagger
```
http://localhost:8000/docs
```

### Что протестировать в Swagger

**1. CREATE (POST /api/cams)**
```json
{
  "name": "Intake Cam",
  "base_radius": 25.0,
  "lift": 10.0,
  "duration": 120.0,
  "project_id": 1
}
```
→ Должен вернуть 201 Created с ID

**2. READ ALL (GET /api/cams)**
→ Должен вернуть список кулачков

**3. READ ONE (GET /api/cams/{id})**
→ Должен вернуть конкретный кулачок
→ Попробуй несуществующий ID → 404

**4. UPDATE (PUT /api/cams/{id})**
```json
{
  "name": "Updated Intake Cam",
  "base_radius": 30.0,
  "lift": 12.0,
  "duration": 130.0,
  "project_id": 1
}
```
→ Должен обновить и вернуть 200 OK

**5. DELETE (DELETE /api/cams/{id})**
→ Должен удалить и вернуть 200 OK
→ Попробуй удалить дважды → 404

**6. ФИЛЬТРАЦИЯ**
- Создай кулачки с разными project_id
- GET /api/cams?project_id=1 → только проекта #1

**7. ПАГИНАЦИЯ**
- Создай 15 кулачков
- GET /api/cams?limit=5&offset=0 → первые 5
- GET /api/cams?limit=5&offset=5 → следующие 5

### Ожидаемый результат

- ✅ Все endpoints работают
- ✅ Правильные HTTP коды возвращаются
- ✅ Валидация данных работает (попробуй отправить строку вместо числа)
- ✅ Фильтрация по project_id работает
- ✅ Пагинация работает

### Как проверить

- [ ] Сервер запускается без ошибок
- [ ] Swagger UI показывает 5 endpoints
- [ ] Можно создать кулачок (POST)
- [ ] Можно получить список (GET all)
- [ ] Можно получить один (GET one)
- [ ] Можно обновить (PUT)
- [ ] Можно удалить (DELETE)
- [ ] 404 для несуществующих ID
- [ ] 422 для неверных данных
- [ ] Фильтрация работает
- [ ] Пагинация работает

---

## ❓ Вопросы для самопроверки

Ответь на эти вопросы своими словами:

1. **HTTP методы:**
   - Чем GET отличается от POST?
   - Что значит "идемпотентный"?
   - Когда использовать PUT vs POST?

2. **CRUD операции:**
   - Какой HTTP метод для Create?
   - Какой HTTP метод для Read?
   - Какой HTTP метод для Update?
   - Какой HTTP метод для Delete?

3. **RESTful URLs:**
   - Что лучше: `/api/cams` или `/api/getCams`? Почему?
   - Как правильно построить URL для получения одного ресурса?
   - Как правильно построить URL для вложенного ресурса?

4. **HTTP статус коды:**
   - Какой код для успешного GET?
   - Какой код для успешного POST (создание)?
   - Какой код если ресурс не найден?
   - Какой код для ошибки валидации?

5. **Для EngineCamPro v2:**
   - Какие endpoints нужны для кулачков?
   - Как будет работать фильтрация?
   - Зачем нужна пагинация?

6. **Работа с Claude Code:**
   - Что нужно указать перед созданием CRUD?
   - Как итеративно добавлять функции?
   - Как тестировать API в Swagger?

---

## 🔗 Связь с другими уроками

**Основано на уроках:**
- Урок 1.2: HTTP протокол - понимание методов
- Урок 1.4: REST API концепции - принципы REST
- Урок 2.1: Введение в FastAPI - создание endpoints

**Подготавливает к урокам:**
- Урок 2.3: Pydantic модели - детальная валидация
- Урок 2.4: Обработка ошибок - правильные коды
- Урок 3.2: База данных - замена временного хранилища

**Связь с EngineCamPro v2:**
CRUD endpoints - это основа API. В следующих уроках ты:
- Добавишь валидацию (Pydantic)
- Подключишь базу данных (PostgreSQL)
- Добавишь endpoint для расчётов POST /api/cams/{id}/calculate

---

## ✅ Критерии завершения урока

**Понимание HTTP методов:**
- [ ] Знаю разницу между GET, POST, PUT, DELETE
- [ ] Понимаю идемпотентность и безопасность
- [ ] Знаю когда какой метод использовать

**CRUD операции:**
- [ ] Понимаю связь CRUD и HTTP методов
- [ ] Могу спроектировать endpoints для ресурса
- [ ] Знаю правильные статус коды

**RESTful дизайн:**
- [ ] Понимаю принципы RESTful URLs
- [ ] Могу отличить хороший URL от плохого
- [ ] Знаю как строить иерархию ресурсов

**Практика:**
- [ ] Создал CRUD API через Claude Code
- [ ] Протестировал все endpoints в Swagger
- [ ] Проверил фильтрацию и пагинацию
- [ ] Понимаю как работает временное хранилище

**Документирование:**
- [ ] Записал выводы
- [ ] Понимаю что делать в следующем уроке

---

**Следующий урок:** 2.3 Pydantic модели и валидация  
**Время на урок:** 45-60 минут  
**Статус:** ⏳ Не начат / 🔄 В процессе / ✅ Завершён

---

*Версия урока: 1.0*  
*Дата создания: 11 октября 2025*  
*Формат: Vibe Coding с диалогами Claude Code*